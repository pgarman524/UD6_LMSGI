<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;10.&nbsp;Programming with the Qizx API</title><link rel="stylesheet" href="html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.1"><link rel="start" href="index.html" title="Qizx Manual"><link rel="up" href="dev_guide.html" title="Part&nbsp;III.&nbsp;Developer's Guide"><link rel="prev" href="dev_guide.html" title="Part&nbsp;III.&nbsp;Developer's Guide"><link rel="next" href="efficient_queries.html" title="Chapter&nbsp;11.&nbsp;Writing efficient queries"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;10.&nbsp;Programming with the Qizx API</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="dev_guide.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;III.&nbsp;Developer's Guide</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="efficient_queries.html">Next</a></td></tr></table><hr></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="programming"></a>Chapter&nbsp;10.&nbsp;Programming with the Qizx API</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="programming.html#d0e4859">1. What you'll learn</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e4948">1.1. About the data samples used in this tutorial</a></span></dt><dt><span class="section"><a href="programming.html#d0e5018">1.2. Compiling and running the code samples</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#lesson_put">2. Creating a Library and populating it with Collections and Documents</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e5328">2.1. Creating a LibraryManager</a></span></dt><dt><span class="section"><a href="programming.html#d0e5379">2.2. Creating a Library</a></span></dt><dt><span class="section"><a href="programming.html#d0e5552">2.3. Creating Collections and importing Documents</a></span></dt><dt><span class="section"><a href="programming.html#d0e5786">2.4. The dual nature of the Library object: both a database and a transactional session</a></span></dt><dt><span class="section"><a href="programming.html#d0e6228">2.5. Compiling and running the code of this lesson</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#lesson_get">3. Retrieving Documents stored in a database</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e6581">3.1. Compiling and running the code of this lesson</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#lesson_query">4. Querying a database</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e6948">4.1. Compiling and running the code of this lesson</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#lesson_delete">5. Deleting Documents and Collections</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e7081">5.1. Compiling and running the code of this lesson</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#lesson_edit">6. Modifying a Document stored in a database</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e7153">6.1. Updating a Document using XQuery Update</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e7250">6.1.1. Compiling and running the code of this lesson</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#d0e7287">6.2. Updating a Document using the Java API and DOM</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e7720">6.2.1. Compiling and running the code of this lesson</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="programming.html#lesson_reindex">7. Customizing the indexing of XML content</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e7762">7.1. Re-indexing a Library</a></span></dt><dt><span class="section"><a href="programming.html#reindex_custom_sieve">7.2. Writing a custom Indexing.NumberSieve</a></span></dt><dt><span class="section"><a href="programming.html#d0e8037">7.3. Compiling and running the code of this lesson</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#lesson_addmeta">8. Adding metadata to Documents</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e8333">8.1. Compiling and running the code of this lesson</a></span></dt></dl></dd><dt><span class="section"><a href="programming.html#d0e8410">9. Convenience and utility classes provided by the API</a></span></dt><dd><dl><dt><span class="section"><a href="programming.html#d0e8430">9.1. Package com.qizx.api.util</a></span></dt><dt><span class="section"><a href="programming.html#d0e8510">9.2. Package com.qizx.api.util.fulltext</a></span></dt><dt><span class="section"><a href="programming.html#d0e8546">9.3. Package com.qizx.api.util.accesscontrol</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4859"></a>1.&nbsp;What you'll learn</h2></div></div></div><p>This edition of Qizx does not include a stand-alone server program. It is designed to be embedded in a <span class="trademark">Java</span>&#8482; application, typically a Servlet. You'll learn in this chapter everything needed to implement a basic application using Qizx. For an introduction to using Qizx, please see the chapter <a class="link" href="getting_started.html" title="Chapter&nbsp;4.&nbsp;Getting started">Getting started</a>.</p><p>The target audience of this chapter are experienced Java programmers, having a good knowledge of XML and at least a basic knowledge of XQuery.</p><p>This chapter is organized in 7 lessons:</p><div class="orderedlist"><ol type="1" compact><li><p><a class="link" href="programming.html#lesson_put" title="2.&nbsp;Creating a Library and populating it with Collections and Documents">First lesson:</a> how to create a database (<code class="interfacename">Library</code>) and populate it with data (<code class="interfacename">Collection</code>s and <code class="interfacename">Document</code>s).</p><p>This lesson is by far the largest one because it contains a refresher about the concepts (<code class="interfacename">LibraryManager</code>, <code class="interfacename">Library</code>, <code class="interfacename">Collection</code>, etc) involved in programming Qizx and also, sidebars about the XML catalog resolver, multi-threading and authorization, which can be skipped on a first reading.</p></li><li><p><a class="link" href="programming.html#lesson_get" title="3.&nbsp;Retrieving Documents stored in a database">Second lesson:</a> how to make local copies of <code class="interfacename">Document</code>s stored in a database.</p></li><li><p><a class="link" href="programming.html#lesson_query" title="4.&nbsp;Querying a database">Third lesson:</a> how to query a database.</p></li><li><p><a class="link" href="programming.html#lesson_delete" title="5.&nbsp;Deleting Documents and Collections">Fourth lesson:</a> how to delete a <code class="interfacename">Document</code>, a <code class="interfacename">Collection</code> or a whole <code class="interfacename">Library</code>.</p></li><li><p><a class="link" href="programming.html#lesson_edit" title="6.&nbsp;Modifying a Document stored in a database">Fifth lesson:</a> how to modify a <code class="interfacename">Document</code> stored in a database.</p></li><li><p><a class="link" href="programming.html#lesson_reindex" title="7.&nbsp;Customizing the indexing of XML content">Sixth lesson:</a> how to customize the indexing of the XML content and how to re-index a database</p></li><li><p><a class="link" href="programming.html#lesson_addmeta" title="8.&nbsp;Adding metadata to Documents">Seventh lesson:</a> how to add metadata (properties) to a <code class="interfacename">Document</code>.</p></li></ol></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4948"></a>1.1.&nbsp;About the data samples used in this tutorial</h3></div></div></div><p>The directory <a class="ulink" href="../samples/book_data/" target="_top"><code class="filename">docs/samples/book_data/</code></a> contains several kinds of XML documents. These short, simple XML documents (a few dozens) serve no other purpose than teaching how to program with the Qizx API. In real life, Qizx can be expected to store and query hundreds of thousands XML documents of multiple sizes, ranging from a few hundreds of bytes to several hundred megabytes.</p><div class="variablelist"><dl><dt><span class="term">Books/</span></dt><dd><p>Each document found in this directory contains the description of a Science-Fiction book: its title, authors, editions, etc. Example <a class="ulink" href="../samples/book_data/Books/The_Robots_of_Dawn.xml" target="_top"><code class="filename">docs/samples/book_data/Books/The_Robots_of_Dawn.xml</code></a>:</p><pre class="programlisting">&lt;book xmlns="http://www.qizx.com/namespace/Tutorial"&gt;
  &lt;title&gt;The Robots of Dawn&lt;/title&gt;
  &lt;author&gt;Isaac Asimov&lt;/author&gt;
  &lt;publicationDate&gt;MCMLXXXIII&lt;/publicationDate&gt;
  &lt;editions&gt;
    &lt;edition&gt;
      &lt;ISBN&gt;0553299492&lt;/ISBN&gt;
      &lt;publisher&gt;Doubleday&lt;/publisher&gt;
      &lt;language&gt;English&lt;/language&gt;
      &lt;year&gt;1983&lt;/year&gt;
    &lt;/edition&gt;
  &lt;/editions&gt;
&lt;/book&gt;</pre></dd><dt><span class="term">Publishers/</span></dt><dd><p>Each document found in this directory contains the description of a publisher: its name, address, etc. Example <a class="ulink" href="../samples/book_data/Publishers/Doubleday.xml" target="_top"><code class="filename">docs/samples/book_data/Publishers/Doubleday.xml</code></a>:</p><pre class="programlisting">&lt;publisher xmlns="http://www.qizx.com/namespace/Tutorial"&gt;
  &lt;trademark&gt;Doubleday&lt;/trademark&gt;
  &lt;company&gt;Random House, Inc.&lt;/company&gt;
  &lt;address xml:space="preserve"&gt;1540 Broadway
New York, NY 10036
US&lt;/address&gt;
&lt;/publisher&gt;</pre></dd><dt><span class="term">Authors/</span></dt><dd><p>Each document found in this directory contains the description of a Science-Fiction author: her/his name, pseudonyms, birth date, etc. Example <a class="ulink" href="../samples/book_data/Authors/iasimov.xml" target="_top"><code class="filename">docs/samples/book_data/Authors/iasimov.xml</code></a>:</p><pre class="programlisting">&lt;author xmlns="http://www.qizx.com/namespace/Tutorial"
  nationality="US" gender="male"&gt;
  &lt;fullName&gt;Isaac Asimov&lt;/fullName&gt;
  &lt;pseudonyms&gt;
    &lt;pseudonym&gt;Paul French&lt;/pseudonym&gt;
    &lt;pseudonym&gt;George E. Dale&lt;/pseudonym&gt;
  &lt;/pseudonyms&gt;
  &lt;birthDate&gt;January 2, 1920&lt;/birthDate&gt;
  &lt;birthPlace&gt;
    &lt;city&gt;Petrovichi&lt;/city&gt;&lt;country&gt;Russian SFSR&lt;/country&gt;
  &lt;/birthPlace&gt;
  &lt;blurb location="../Author%20Blurbs/Isaac_Asimov.xhtml"/&gt;
&lt;/author&gt;</pre></dd><dt><span class="term">Author Blurbs/</span></dt><dd><p>Each document found in this directory is an XHTML page which is a copy of a <a class="ulink" href="http://wikipedia.org/" target="_top">Wikipedia</a> article describing a Science-Fiction author. Example <a class="ulink" href="../samples/book_data/Author%20Blurbs/Isaac_Asimov.xhtml" target="_top"><code class="filename">docs/samples/book_data/Author Blurbs/Isaac_Asimov.xhtml</code></a>:</p><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr"
lang="en"&gt;
&lt;head&gt;
...
&lt;title&gt;Isaac Asimov - Wikipedia, the free encyclopedia&lt;/title&gt;
...
&lt;/body&gt;
&lt;/html&gt;</pre><p>The XHTML DTD and the corresponding <a class="ulink" href="http://xml.apache.org/commons/components/resolver/resolver-article.html" target="_top">XML Catalog</a> are found in <a class="ulink" href="../samples/xhtml_dtd/" target="_top"><code class="filename">docs/samples/xhtml_dtd/</code></a>.</p></dd></dl></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5018"></a>1.2.&nbsp;Compiling and running the code samples</h3></div></div></div><p>All the code samples used to illustrate this chapter are found in the <a class="ulink" href="../samples/programming/" target="_top"><code class="filename">docs/samples/programming/</code></a> directory. Files containing XQuery scripts are found in the <a class="ulink" href="../samples/book_queries/" target="_top"><code class="filename">docs/samples/book_queries/</code></a> directory.</p><p>You'll need a recent version of <a class="ulink" href="http://ant.apache.org/" target="_top">ant</a>, a Java-based build tool<sup>[<a name="d0e5036" href="#ftn.d0e5036" class="footnote">3</a>]</sup> to compile and run the codes samples.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="lesson_put"></a>2.&nbsp;Creating a Library and populating it with Collections and Documents</h2></div></div></div><p>The <code class="classname">Put</code> class implements a command-line tool allowing to create a <code class="interfacename">Library</code> and populate it with <code class="interfacename">Collection</code>s and <code class="interfacename">Document</code>s. More precisely, it allows to copy one or more source files or directories to a single destination <code class="interfacename">Collection</code> or <code class="interfacename">Document</code>. If multiple sources are specified, the destination must be an existing <code class="interfacename">Collection</code>. Moreover the <code class="classname">Put</code> class allows to filter what's being copied by the means of a simple <code class="interfacename">java.io.FileFilter</code>.</p><p>The outline of this program is (excerpts of <a class="ulink" href="../samples/programming/put/Put.java" target="_top"><code class="filename">Put.java</code></a>):</p><pre class="programlisting">        LibraryManager libManager = getLibraryManager(storageDir);<a class="co" name="put_getLibraryManager" href="programming.html#put_getLibraryManager_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        Library lib = getLibrary(libManager, libName);<a class="co" name="put_getLibrary" href="programming.html#put_getLibrary_2"><img src="images/callouts/2.png" alt="2" border="0"></a>

        LibraryMember dst = lib.getMember(dstPath);
        boolean dstIsCollection = (dst != null &amp;&amp; dst.isCollection());

        if (args.length &gt; l+4 &amp;&amp; !dstIsCollection) {
            shutdown(lib, libManager);
            usage("'" + dstPath + "', does not exist or is a document");
        }

        try {
            for (int i = l+2; i &lt; last; ++i) {
                File srcFile = new File(args[i]);

                String dstPath2 = dstPath;
                if (dstIsCollection) {
                    dstPath2 = joinPath(dstPath, srcFile.getName());
                }
                put(lib, srcFile, filter, dstPath2);<a class="co" name="put_put" href="programming.html#put_put_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
            }

            verbose("Committing changes...");
            lib.commit();<a class="co" name="put_doCommit" href="programming.html#put_doCommit_2"><img src="images/callouts/4.png" alt="4" border="0"></a>
        } finally {
            shutdown(lib, libManager);<a class="co" name="put_shutdown" href="programming.html#put_shutdown_2"><img src="images/callouts/5.png" alt="5" border="0"></a>
        }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="put_getLibraryManager_2"></a><a href="#put_getLibraryManager"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>Get a <code class="interfacename">LibraryManager</code>. ``Create it'' if it does not exist.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_getLibrary_2"></a><a href="#put_getLibrary"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>Get a <code class="interfacename">Library</code> from the <code class="interfacename">LibraryManager</code>. Create it if it does not exist.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_put_2"></a><a href="#put_put"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>For each source directory, create the corresponding <code class="interfacename">Collection</code> in the <code class="interfacename">Library</code>. Assume that each source file is a well-formed XML document and import it in the <code class="interfacename">Library</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_doCommit_2"></a><a href="#put_doCommit"><img src="images/callouts/4.png" alt="4" border="0"></a> </p></td><td valign="top" align="left"><p>Commit changes made to the <code class="interfacename">Library</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_shutdown_2"></a><a href="#put_shutdown"><img src="images/callouts/5.png" alt="5" border="0"></a> </p></td><td valign="top" align="left"><p>Close the <code class="interfacename">Library</code>. ``Close'' the <code class="interfacename">LibraryManager</code>.</p></td></tr></table></div><p>Objects involved:</p><div class="variablelist"><dl><dt><span class="term"><code class="interfacename">LibraryManager</code></span></dt><dd><p>A <a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html" target="_top"><code class="interfacename">LibraryManager</code></a> is similar to a database manager. It allows to open or create Libraries.</p></dd><dt><span class="term"><code class="interfacename">Library</code></span></dt><dd><p>A <a class="ulink" href="../javadoc/com/qizx/api/Library.html" target="_top"><code class="interfacename">Library</code></a> is similar to a database. If we use the filesystem analogy, a <code class="interfacename">Library</code> is similar to a disk drive.</p><p>A <code class="interfacename">Library</code> has a name<sup>[<a name="d0e5168" href="#ftn.d0e5168" class="footnote">4</a>]</sup>. A <code class="interfacename">Library</code> always contains a root <code class="interfacename">Collection</code>, named "<code class="literal">/</code>", which cannot be deleted.</p></dd><dt><span class="term"><code class="interfacename">Collection</code></span></dt><dd><p>If we use the filesystem analogy, a <a class="ulink" href="../javadoc/com/qizx/api/Collection.html" target="_top"><code class="interfacename">Collection</code></a> is similar to a directory. It can contain <code class="interfacename">Document</code>s and/or <code class="interfacename">Collection</code>s.</p><p>Note that nothing forces you to create a hierarchy of <code class="interfacename">Collection</code>s. If you prefer, you can import all your <code class="interfacename">Document</code>s in the root <code class="interfacename">Collection</code>.</p></dd><dt><span class="term"><code class="interfacename">Document</code></span></dt><dd><p>If we use the filesystem analogy, a <a class="ulink" href="../javadoc/com/qizx/api/Document.html" target="_top"><code class="interfacename">Document</code></a> is similar to a file. Unlike plain files, the content of a <code class="interfacename">Document</code> is always well-formed XML.</p></dd><dt><span class="term"><code class="interfacename">LibraryMember</code></span></dt><dd><p>A common term (super-interface) for both <code class="interfacename">Collection</code> and <code class="interfacename">Document</code>.</p><p>Like its filesystem counterpart, a <a class="ulink" href="../javadoc/com/qizx/api/LibraryMember.html" target="_top"><code class="interfacename">LibraryMember</code></a> has a <em class="firstterm">path</em>. Path components are separated by a slash character "<code class="literal">/</code>". The last component is the name of the <code class="interfacename">LibraryMember</code>. The other path components are the names of the ancestor <code class="interfacename">Collection</code>s of the <code class="interfacename">LibraryMember</code>, up to the root <code class="interfacename">Collection</code> "<code class="literal">/</code>".</p><p>Example: "<code class="literal">/foo/bar/gee</code>". The name of this <code class="interfacename">LibraryMember</code> is "<code class="literal">gee</code>". Its ancestor <code class="interfacename">Collection</code>s are, from direct parent to the root: "<code class="literal">bar</code>", "<code class="literal">foo</code>", "<code class="literal">/</code>".</p><p>There is no concept of current working <code class="interfacename">Collection</code>, therefore relative paths are not useful.</p><p>Note that the name of <code class="interfacename">LibraryMember</code> may contain any character supported by <span class="trademark">Java</span>&#8482; (including whitespace), except the slash character "<code class="literal">/</code>".</p><p>Unlike its filesystem counterpart, a <code class="interfacename">LibraryMember</code> may have any number of user-defined <em class="firstterm">properties</em> (<em class="firstterm">meta-data</em>) in addition to its content (that is, XML content for a <code class="interfacename">Document</code>, members for a <code class="interfacename">Collection</code>). More on properties in <a class="link" href="programming.html#lesson_addmeta" title="8.&nbsp;Adding metadata to Documents">lesson 7</a>.</p></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5328"></a>2.1.&nbsp;Creating a LibraryManager</h3></div></div></div><pre class="programlisting">    private static LibraryManager getLibraryManager(File storageDir) 
        throws IOException, QizxException
    {
        if (storageDir.exists()) {<a class="co" name="put_storageDir_exists" href="programming.html#put_storageDir"><img src="images/callouts/1.png" alt="1" border="0"></a>
            return Configuration.openLibraryGroup(storageDir);<a class="co" name="put_openLibraryGroup" href="programming.html#put_obtain_LibraryManager"><img src="images/callouts/2.png" alt="2" border="0"></a>
        } else {
            if (!storageDir.mkdirs()) {<a class="co" name="put_storageDir_create" href="programming.html#put_storageDir"><img src="images/callouts/3.png" alt="3" border="0"></a>
                throw new IOException("cannot create directory '" + 
                                      storageDir + "'");
            }

            verbose("Creating library group in '" + storageDir + "'...");
            return Configuration.createLibraryGroup(storageDir);<a class="co" name="put_createLibraryGroup" href="programming.html#put_obtain_LibraryManager"><img src="images/callouts/4.png" alt="4" border="0"></a>
        }
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="put_storageDir"></a><a href="#put_storageDir_create"><img src="images/callouts/3.png" alt="3" border="0"></a> <a href="#put_storageDir_exists"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>A <a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html" target="_top"><code class="interfacename">LibraryManager</code></a> stores all its data (XML content, indexes, etc) in a single directory of the filesystem. Creating <code class="interfacename">LibraryManager</code> automatically creates this directory if it does not already exist. In the above code, we have preferred to create the storage directory ``by hand'', before invoking <code class="methodname">createLibraryGroup</code>. See also <a class="xref" href="programming.html#delete_LibraryManager" title="How to delete a LibraryManager">How to delete a <code class="interfacename">LibraryManager</code></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_obtain_LibraryManager"></a><a href="#put_createLibraryGroup"><img src="images/callouts/4.png" alt="4" border="0"></a> <a href="#put_openLibraryGroup"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>A <code class="interfacename">LibraryManager</code> is obtained by using the <a class="ulink" href="../javadoc/com/qizx/api/LibraryManagerFactory.html#openLibraryGroup(java.io.File)" target="_top"><code class="methodname">openLibraryGroup</code></a> or <a class="ulink" href="../javadoc/com/qizx/api/LibraryManagerFactory.html#createLibraryGroup(java.io.File)" target="_top"><code class="methodname">createLibraryGroup</code></a> methods of the <a class="ulink" href="../javadoc/com/qizx/api/Configuration.html" target="_top"><code class="classname">Configuration</code></a> class.</p><p>Class Configuration supports many options that can be set before creating or opening a Library Group or LibraryManager.</p><p>Note: LibraryManagerFactory is now deprecated.</p></td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5379"></a>2.2.&nbsp;Creating a Library</h3></div></div></div><pre class="programlisting">    private static Library getLibrary(LibraryManager libManager,
                                      String libName) 
        throws QizxException {
        Library lib = libManager.openLibrary(libName);<a class="co" name="put_openLibrary" href="programming.html#put_openLibrary_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        if (lib == null) {
            verbose("Creating library '" + libName + "'...");
            libManager.createLibrary(libName);<a class="co" name="put_createLibrary" href="programming.html#put_createLibrary_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
            lib = libManager.openLibrary(libName);
        }
        return lib;
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="put_openLibrary_2"></a><a href="#put_openLibrary"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html#openLibrary(java.lang.String,%20com.qizx.api.User)" target="_top"><code class="methodname">openLibrary</code></a> returns the <code class="interfacename">Library</code> having the specified name. It returns <code class="literal">null</code> if such <code class="interfacename">Library</code> does not exist.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_createLibrary_2"></a><a href="#put_createLibrary"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html#createLibrary(java.lang.String,%20com.qizx.api.User)" target="_top"><code class="methodname">createLibrary</code></a> creates the <code class="interfacename">Library</code> having the specified name.</p></td></tr></table></div><div class="sidebar"><a name="put_authorization"></a><p class="title"><b>Access Control</b></p><p>In this tutorial, we never care to control which user is modifying or querying the "<code class="literal">Tutorial</code>" Library:</p><pre class="programlisting">Library lib = libManager.openLibrary(libName);</pre><p>For some applications, this is fine, but some applications really need to be able to control who is accessing <code class="interfacename">Collection</code>s and <code class="interfacename">Document</code>s. This is called <em class="glossterm">access control</em>.</p><p>Qizx Server has a default access control mechanism based on ACL (Access Control Lists).</p><p>The core Qizx has no built-in authorization mechanism but lets you define one if you need to:</p><div class="orderedlist"><ol type="1"><li><p>Implement interface <a class="ulink" href="../javadoc/com/qizx/api/User.html" target="_top"><code class="interfacename">com.qizx.api.User</code></a>.</p><p>This object models the user of a <code class="interfacename">Library</code>. (Remember that a <code class="interfacename">Library</code> is at the same time a database and the<span class="emphasis"><em> transactional session</em></span> used to modify and/or query this database.)</p><p>Qizx itself is not much concerned by the implementation of the <code class="interfacename">User</code> object. For Qizx, a <code class="interfacename">User</code> is an opaque object associated to a session and passed to an <code class="interfacename">AccessControl</code> object to check whether an operation is allowed.</p></li><li><p>Implement interface <a class="ulink" href="../javadoc/com/qizx/api/AccessControl.html" target="_top"><code class="interfacename">com.qizx.api.AccessControl</code></a>.</p><p>This object is used to check whether a given <code class="interfacename">User</code> is allowed to perform a operation (read properties, write properties, read content or write content) on a given <code class="interfacename">Collection</code> or <code class="interfacename">Document</code>.</p><p>Your implementation must be fast because the following methods are invoked very often:</p><pre class="programlisting">boolean mayReadContent(User user, LibraryMember member);
boolean mayReadProperty(User user, LibraryMember member, String propertyName);</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>The API packages contain a base implementation <a class="ulink" href="../javadoc/com/qizx/server/util/accesscontrol/AccessControlBase.html" target="_top"><code class="classname">com.qizx.server.util.accesscontrol.AccessControlBase</code></a> which can be extended, and an actual implementation <a class="ulink" href="../javadoc/com/qizx/server/util/accesscontrol/ACLAccessControl.html" target="_top"><code class="classname">com.qizx.server.util.accesscontrol.ACLAccessControl</code></a>.</p></div><p>Permissions (e.g. group "<code class="literal">Authors</code>" is allowed to add <code class="interfacename">Document</code>s to <code class="interfacename">Collection</code> "<code class="literal">/Submissions</code>") can typically be stored as properties of a <code class="interfacename">LibraryMember</code> (that is, a <code class="interfacename">Collection</code> or <code class="interfacename">Document</code>). See <a class="ulink" href="../javadoc/com/qizx/api/LibraryMember.html#setProperty(java.lang.String,%20java.lang.Object)" target="_top"><code class="methodname">LibraryMember.setProperty</code></a>.</p></li><li><p>As of version 4.0, User and AccessControl are defined when opening a Library session:</p><pre class="programlisting">Library lib = libManager.openLibrary(libName, user, accessControl);</pre><p>Whether the accessControl instance is specific to the session, or shared by sessions, is up to your implementation. If shared, the implementation must be thread-safe.</p></li><li><p>A valid <code class="interfacename">User</code> must be passed when you open a <code class="interfacename">Library</code>.</p><p>Obtaining a <code class="interfacename">User</code> from valid credentials is a process called <em class="firstterm">Authentication</em>. Authentication is orthogonal to authorization. Qizx being an embedded database engine, it is not concerned about authentication.</p></li></ol></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5552"></a>2.3.&nbsp;Creating Collections and importing Documents</h3></div></div></div><pre class="programlisting">    private static void put(Library lib,File srcFile, FileFilter filter,
                            String dstPath) 
        throws IOException, QizxException {
        if (srcFile.isDirectory()) {
            Collection collection = lib.getCollection(dstPath);<a class="co" name="put_getCollection" href="programming.html#put_getCollection_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
            if (collection == null) {
                verbose("Creating collection '" + dstPath + "'...");
                collection = lib.createCollection(dstPath);<a class="co" name="put_createCollection" href="programming.html#put_createCollection_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
            }

            File[] files = srcFile.listFiles(filter);
            if (files == null) {
                throw new IOException("cannot list directory '" + 
                                      srcFile + "'");
            }

            for (int i = 0; i &lt; files.length; ++i) {
                File file = files[i];
                put(lib, file, filter, joinPath(dstPath, file.getName()));
            }
        } else {
            verbose("Importing '" + srcFile + "' as document '" + 
                    dstPath + "'...");
            lib.importDocument(dstPath, srcFile);<a class="co" name="put_importDocument" href="programming.html#put_importDocument_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
        }
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="put_getCollection_2"></a><a href="#put_getCollection"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p><code class="interfacename">Library</code> has several methods returning a <code class="interfacename">LibraryMember</code>: <a class="ulink" href="../javadoc/com/qizx/api/Library.html#getCollection(java.lang.String)" target="_top"><code class="methodname">getCollection</code></a>, <a class="ulink" href="../javadoc/com/qizx/api/Library.html#getDocument(java.lang.String)" target="_top"><code class="methodname">getDocument</code></a>, <a class="ulink" href="../javadoc/com/qizx/api/Library.html#getMember(java.lang.String)" target="_top"><code class="methodname">getMember</code></a>. All these methods must be passed absolute paths.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_createCollection_2"></a><a href="#put_createCollection"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>A <code class="interfacename">Collection</code> is created by invoking <a class="ulink" href="../javadoc/com/qizx/api/Library.html#createCollection(java.lang.String)" target="_top"><code class="methodname">createCollection</code></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_importDocument_2"></a><a href="#put_importDocument"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>A <code class="interfacename">Document</code> is created by invoking one of the several <a class="ulink" href="../javadoc/com/qizx/api/Library.html#importDocument(java.lang.String,%20java.io.File)" target="_top"><code class="methodname">importDocument</code></a> methods. These methods differ by the types of their source arguments: <code class="classname">java.io.File</code>, <code class="classname">java.net.URL</code>, <code class="classname">org.xml.sax.InputSource</code>, etc. In all cases, the source must contain well-formed XML.</p><p>Note that if a <code class="interfacename">Document</code> already exists, <code class="methodname">importDocument</code> allows to change its content.</p><p>Now what if your XML source is not a file? May be your XML source is a <a class="ulink" href="http://java.sun.com/j2se/1.4.2/docs/api/org/w3c/dom/package-summary.html" target="_top">W3C <acronym class="acronym">DOM</acronym></a> Document or a <a class="ulink" href="http://www.jdom.org/" target="_top">JDOM</a> Document. Or may be you want to dynamically create a <code class="interfacename">Document</code>. In such case, you'll need to use the <a class="ulink" href="../javadoc/com/qizx/api/Library.html#beginImportDocument(java.lang.String)" target="_top"><code class="methodname">beginImportDocument</code></a> and <a class="ulink" href="../javadoc/com/qizx/api/Library.html#endImportDocument()" target="_top"><code class="methodname">endImportDocument</code></a> low-level methods.</p><p>Example: dynamically create a <code class="interfacename">Document</code> containing "<code class="literal">&lt;hello xmlns="http://www.acme.com/ns/test"&gt;Hello world!&lt;/hello&gt;</code>":</p><pre class="programlisting">XMLPushStream out = lib.<span class="bold"><strong>beginImportDocument</strong></span>(docPath);
out.putDocumentStart();
QName helloName = lib.getQName("hello", "http://www.acme.com/ns/test");
out.putElementStart(helloName);
out.putText("Hello world!");
out.putElementElement(helloName);
out.putDocumentEnd();
Document doc = lib.<span class="bold"><strong>endImportDocument</strong></span>();</pre><p>The <a class="ulink" href="../javadoc/com/qizx/api/XMLPushStream.html" target="_top"><code class="interfacename">XMLPushStream</code></a> interface returned by <code class="methodname">beginImportDocument</code> allows to ``push XML content'' into a <code class="interfacename">Document</code>. This is a pretty low-level interface, similar to SAX. Fortunately, Qizx comes with two handy adapters:</p><div class="variablelist"><dl><dt><span class="term"><a class="ulink" href="../javadoc/com/qizx/api/util/DOMToPushStream.html" target="_top"><code class="classname">com.qizx.api.util.DOMToPushStream</code></a></span></dt><dd><p>Copies a W3C <acronym class="acronym">DOM</acronym> document or element to an <code class="interfacename">XMLPushStream</code>. This utility class is used in <a class="link" href="programming.html#lesson_edit" title="6.&nbsp;Modifying a Document stored in a database">lesson 5</a>.</p></dd><dt><span class="term"><a class="ulink" href="../javadoc/com/qizx/api/util/SAXToPushStream.html" target="_top"><code class="classname">com.qizx.api.util.SAXToPushStream</code></a></span></dt><dd><p>Implements <code class="interfacename">org.xml.sax.ContentHandler</code>, <code class="interfacename">org.xml.sax.ext.LexicalHandler</code>, etc, to convert SAX events to invocations of the corresponding methods in an <code class="interfacename">XMLPushStream</code>.</p></dd></dl></div></td></tr></table></div><div class="sidebar"><a name="put_catalog_resolver"></a><p class="title"><b>Using the XML catalog resolver</b></p><p>XML documents conforming to a DTD start with a <code class="literal">&lt;!DOCTYPE&gt;</code> looking like this:</p><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</pre><p>Qizx needs to parse a document in order to be able to import it in a database. The first step of parsing consists in downloading and parsing the DTD itself. If this first step fails, the whole import process fails too.</p><p>In the above example, the DTD, <code class="uri">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</code>, is found on a remote server. Downloading the DTD from this server could fail if there is no network access, moreover it could make the import process very slow.</p><p>The solution to this problem is to use an <em class="firstterm">XML catalog</em>. To make it simple, an XML catalog is a file, using a very simple XML vocabulary, which associates the public ID of a DTD to a local copy of this DTD:</p><pre class="programlisting">&lt;catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog"
         prefer="public"&gt;
  ...
  &lt;public publicId="-//W3C//DTD XHTML 1.0 Transitional//EN"<a class="co" name="xml_catalog_publicId" href="programming.html#xml_catalog_publicId_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
          uri="xhtml1-transitional.dtd"/&gt;<a class="co" name="xml_catalog_uri" href="programming.html#xml_catalog_uri_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
  ...
&lt;/catalog&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="xml_catalog_publicId_2"></a><a href="#xml_catalog_publicId"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The public ID of the DTD is <code class="literal">"-//W3C//DTD XHTML 1.0 Transitional//EN"</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="xml_catalog_uri_2"></a><a href="#xml_catalog_uri"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>The local copy is found in <code class="uri">"xhtml1-transitional.dtd"</code> (a relative URI is relative to the URI of the XML catalog file).</p></td></tr></table></div><p>Qizx is bundled with <code class="filename">resolver.jar</code>, the XML catalog resolver which is part of the <a class="ulink" href="http://xml.apache.org/commons/components/resolver/index.html" target="_top">Apache XML Commons</a> project. Methods such as <a class="ulink" href="../javadoc/com/qizx/api/Library.html#importDocument(java.lang.String,%20java.io.File)" target="_top"><code class="methodname">Library.importDocument</code></a> are, of course, XML-catalog enabled. Therefore suffice to specify one or more XML catalogs and to let the XML catalog resolver know about them. Doing so is straightforward and is well explained in <a class="ulink" href="http://xml.apache.org/commons/components/resolver/resolver-article.html" target="_top">the "<em class="citetitle">XML Entity and URI Resolvers</em>" article by Norman Walsh</a>.</p><p>In this tutorial, we have chosen the most lightweight method for configuring the XML catalog resolver: using system properties. Excerpts of <a class="ulink" href="../samples/programming/put/build.xml" target="_top"><code class="filename">docs/samples/programming/put/build.xml</code></a>:</p><pre class="programlisting">  &lt;target name="run" depends="compile"&gt;
    &lt;java classpathref="cp" fork="yes" classname="Put"&gt;
      &lt;sysproperty key="<span class="bold"><strong>xml.catalog.files</strong></span>" 
                   value="<span class="bold"><strong>${basedir}/../../xhtml_dtd/catalog.xml</strong></span>" /&gt;
      &lt;sysproperty key="xml.catalog.prefer" value="public" /&gt;
      &lt;sysproperty key="xml.catalog.verbosity" value="0" /&gt;
      ...
    &lt;/java&gt;
  &lt;/target&gt;</pre><p>An alternative method would be to add a <code class="filename">CatalogManager.properties</code> properties file to the <code class="envar">CLASSPATH</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5786"></a>2.4.&nbsp;The dual nature of the Library object: both a database and a transactional session</h3></div></div></div><p>A <a class="ulink" href="../javadoc/com/qizx/api/Library.html" target="_top"><code class="interfacename">Library</code></a> is both a database (or a disk drive, if we use the filesystem analogy) and <span class="emphasis"><em>a transactional session allowing to modify and/or query this database</em></span>. As such, a sequence of changes made to a <code class="interfacename">Library</code> must end with <a class="ulink" href="../javadoc/com/qizx/api/Library.html#commit()" target="_top"><code class="methodname">commit</code></a> or <a class="ulink" href="../javadoc/com/qizx/api/Library.html#rollback()" target="_top"><code class="methodname">rollback</code></a>.</p><pre class="programlisting">        ...
            verbose("Committing changes...");
            lib.commit();<a class="co" name="put_commit" href="programming.html#put_commit_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        } finally {
            shutdown(lib, libManager);
        }
        ...

    private static void shutdown(Library lib, LibraryManager libManager) 
        throws QizxException {
        if (lib.isModified()) {<a class="co" name="put_isModified" href="programming.html#put_isModified_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
            lib.rollback();
        }
        lib.close();<a class="co" name="put_close" href="programming.html#put_close_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
        libManager.closeAllLibraries(10000 /*ms*/);<a class="co" name="put_closeAllLibraries" href="programming.html#put_closeAllLibraries_2"><img src="images/callouts/4.png" alt="4" border="0"></a>
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="put_commit_2"></a><a href="#put_commit"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The <a class="ulink" href="../javadoc/com/qizx/api/Library.html#commit()" target="_top"><code class="methodname">commit</code></a> method is invoked to commit the changes made to the <code class="interfacename">Library</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_isModified_2"></a><a href="#put_isModified"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>The <code class="methodname">shutdown</code> helper is invoked even when the program crashes before committing the changes made to the <code class="interfacename">Library</code>. The <a class="ulink" href="../javadoc/com/qizx/api/Library.html#isModified()" target="_top"><code class="methodname">isModified</code></a> method may be used to test this case, becausem a successful commit clears the modified flag. When this error case happens, you need to invoke the <a class="ulink" href="../javadoc/com/qizx/api/Library.html#rollback()" target="_top"><code class="methodname">rollback</code></a> method to restore the state of the <code class="interfacename">Library</code> before the changes.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_close_2"></a><a href="#put_close"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>Note that the <a class="ulink" href="../javadoc/com/qizx/api/Library.html#close()" target="_top"><code class="methodname">close</code></a> method raises a <a class="ulink" href="../javadoc/com/qizx/api/QizxException.html" target="_top"><code class="classname">QizxException</code></a> if the database has been modified and <code class="methodname">commit</code> or <code class="methodname">rollback</code> have not been invoked.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_closeAllLibraries_2"></a><a href="#put_closeAllLibraries"><img src="images/callouts/4.png" alt="4" border="0"></a> </p></td><td valign="top" align="left"><p>A <a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html" target="_top"><code class="methodname">LibraryManager</code></a> has no <code class="methodname">close</code> method. However, you really need to invoke its <a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html#closeAllLibraries(int)" target="_top"><code class="methodname">closeAllLibraries</code></a> method to stop worker threads. If you don't do that, your application may not be able to exit.</p></td></tr></table></div><div class="sidebar"><a name="put_multi-threading"></a><p class="title"><b>Concurrency and multi-threading</b></p><p>Qizx has been designed from the ground up to be embedded in multi-threaded applications, where a number of threads may concurrently perform queries and updates on the same XML Library.</p><p>In this respect there are some fundamental points to be remembered:</p><div class="orderedlist"><ol type="1"><li><p>Classes (<code class="interfacename">Configuration</code>, <code class="interfacename">LibraryManager</code>) used to get a <code class="interfacename">Library</code> are thread-safe.</p></li><li><p>A <code class="interfacename">Library</code> and all objects obtained directly or indirectly from a <code class="interfacename">Library</code> (<code class="interfacename">Collection</code>, <code class="interfacename">Document</code>, etc) are not designed to be shared across different threads. That is, each thread must act upon its own, private, <code class="interfacename">Library</code><sup>[<a name="d0e5918" href="#ftn.d0e5918" class="footnote">5</a>]</sup>.</p></li><li><p>A Library (as session) provides <span class="emphasis"><em>isolation</em></span><sup>[<a name="put_acid" href="#ftn.put_acid" class="footnote">6</a>]</sup>. This means that a session has a <span class="emphasis"><em>stable view</em></span> of a database and does <span class="emphasis"><em>not</em></span> see updates made by other sessions, unless certain operations like commit, rollback and refresh are performed explicitly. This is a useful feature when performing complex queries and transformations, because its provides a consistent environment, but it implies some constraints as we will see hereafter.</p></li></ol></div><p>Let us consider what happens when several client sessions (interface Library), each associated with its thread, are doing concurrent queries and updates:</p><div class="itemizedlist"><ul type="disc"><li><p>Due to isolation, it is perfectly possible for a session to see, read, and query documents which have in fact already been deleted or replaced by another session.</p></li><li><p>For this reason, before starting an update operation a session must ensure it has got the latest state of the database.</p></li><li><p>And of course we have a classical problem of concurrent updates: a synchronization mechanism is needed to ensure that a transaction does not spoil the work of another transaction, so that the final result is what was intended.</p></li></ul></div><p>In order to illustrate this problem in a more concrete way, let us consider an example of what we could call a <span class="emphasis"><em>long-lived session</em></span>. Note that the programming style of this example is not very good, it only serves for explanation purpose:</p><pre class="programlisting">Library lib = libManager.openLibrary("MyLib"); <span class="emphasis"><em>// AS=121,SS=121</em></span> <a class="co" name="put_as121" href="programming.html#put_as121_2"><img src="images/callouts/1.png" alt="1" border="0"></a>

Thread.sleep(10);

<span class="emphasis"><em>//AS=121,SS=121</em></span>
Expression expr = lib.compileExpression(query1);<a class="co" name="put_ss121" href="programming.html#put_ss121_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
ItemSequence results = expr.evaluate();

Thread.sleep(10000);

<span class="emphasis"><em>//AS=123,SS=121</em></span>
expr = lib.compileExpression(query1);<a class="co" name="put_as123" href="programming.html#put_as123_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
ItemSequence results = expr.evaluate();

<span class="emphasis"><em>//AS=123,SS=121</em></span>
lib.importDocument(file1, "/maps/Germany.xml");
lib.commit(); /<span class="emphasis"><em>/AS=124,SS=124</em></span> <a class="co" name="put_as124" href="programming.html#put_as124_2"><img src="images/callouts/4.png" alt="4" border="0"></a>

Thread.sleep(10000);

<span class="emphasis"><em>//AS=130,SS=124</em></span>
Document doc = lib.getDocument("/maps/Germany.xml");
doc.setProperty("lastModified", new Date());<a class="co" name="put_as130" href="programming.html#put_as130_2"><img src="images/callouts/5.png" alt="5" border="0"></a>
lib.commit(); <span class="emphasis"><em>//AS=131,SS=131</em></span>

lib.close();</pre><p><span class="bold"><strong><code class="literal">AS</code> </strong></span>denotes the actual data state of <code class="interfacename">Library</code> "<code class="literal">MyLib</code>". <span class="bold"><strong><code class="literal">SS</code></strong></span> denotes the data state as seen by the above session.</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="put_as121_2"></a><a href="#put_as121"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>Just after opening <code class="interfacename">Library</code> "<code class="literal">MyLib</code>", its internal data state is #121.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_ss121_2"></a><a href="#put_ss121"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>Query <code class="literal">query1</code> is performed on data state #121.</p><p>Because no concurrent thread has modified <code class="interfacename">Library</code> "<code class="literal">MyLib</code>" between the time the <code class="interfacename">Library</code> was opened and the query is performed, the results of this query reflect the reality of the database.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_as123_2"></a><a href="#put_as123"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>Query <code class="literal">query1</code> is still performed on data state #121, due to the Isolation feature of Qizx. Therefore this query will give exactly the same results as the previous one.</p><p>However it happens that a number of concurrent threads have modified the <code class="interfacename">Library</code> since last query (the actual data state is #123, and not #121 as seen by the session), thus the results of this query do not reflect the reality of the database.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_as124_2"></a><a href="#put_as124"><img src="images/callouts/4.png" alt="4" border="0"></a> </p></td><td valign="top" align="left"><p>Methods <a class="ulink" href="../javadoc/com/qizx/api/Library.html#commit()" target="_top"><code class="methodname">commit</code></a> and <a class="ulink" href="../javadoc/com/qizx/api/Library.html#rollback()" target="_top"><code class="methodname">rollback</code></a> automatically ``refresh the data state of a session''. Therefore from now, the data state as seen by the session is #124.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="put_as130_2"></a><a href="#put_as130"><img src="images/callouts/5.png" alt="5" border="0"></a> </p></td><td valign="top" align="left"><p>A number of concurrent threads have modified the database, and now its actual data state is #130. Among the changes, <code class="interfacename">Document</code> "<code class="literal">/maps/Germany.xml</code>" has been deleted. Due to Isolation feature of Qizx, our session is still able to add a property to this <code class="interfacename">Document</code>!</p></td></tr></table></div><p>The term <span class="emphasis"><em>long-lived session</em></span> means that the session is used for several operations, whether read-only queries or updates. When you program long-lived sessions, you should systematically:</p><div class="itemizedlist"><ul type="disc"><li><p>before a query or a data extraction, use <a class="ulink" href="../javadoc/com/qizx/api/Library.html#refresh()" target="_top"><code class="methodname">Library.refresh</code></a> to ensure that your session sees the latest state of the database.</p></li><li><p>before updates, lock the <code class="interfacename">Document</code> or <code class="interfacename">Collection</code> which is to be modified by using <a class="ulink" href="../javadoc/com/qizx/api/Library.html#lockDocument(java.lang.String,%20int)" target="_top"><code class="methodname">Library.lockDocument</code></a> or <a class="ulink" href="../javadoc/com/qizx/api/Library.html#lockCollection(java.lang.String,%20int)" target="_top"><code class="methodname">Library.lockCollection</code></a>. Then, finish the sequence of updates by invoking <a class="ulink" href="../javadoc/com/qizx/api/Library.html#commit()" target="_top"><code class="methodname">Library.commit</code></a> or <a class="ulink" href="../javadoc/com/qizx/api/Library.html#rollback()" target="_top"><code class="methodname">Library.rollback</code></a>.</p><p>About the lock methods:</p><div class="itemizedlist"><ul type="circle" compact><li><p>A lock method, as the name says, ensures exclusive access to one or several library members. If one library member is already locked by another session, it is possible to wait for a certain amount of time until it is unlocked.</p></li><li><p>The lock methods, like <code class="methodname">commit</code> and <code class="methodname">rollback</code>, automatically ``refresh the view of Library''.</p></li><li><p>There is no unlock method. Methods <code class="methodname">commit</code> and <code class="methodname">rollback</code> automatically remove the current lock if any.</p></li><li><p>It is not possible to make several calls to a lock method without invoking <code class="methodname">commit</code> or <code class="methodname">rollback</code> before each new lock (in other terms, only one lock is allowed per commit).</p><p>If you need to modify several <code class="interfacename">LibraryMember</code>s within the same transaction, you can either lock their common ancestor<sup>[<a name="d0e6149" href="#ftn.d0e6149" class="footnote">7</a>]</sup> using method <a class="ulink" href="../javadoc/com/qizx/api/Library.html#lockCollection(java.lang.String,%20int)" target="_top"><code class="methodname">Library.lockCollection</code></a> or, better, use method <a class="ulink" href="../javadoc/com/qizx/api/Library.html#lock(java.lang.String[],%20int)" target="_top"><code class="methodname">Library.lock</code></a>, which locks several objects atomically.</p></li></ul></div></li></ul></div><p>The above example may now be rewritten as:</p><pre class="programlisting">Library lib = libManager.openLibrary("MyLib");

Thread.sleep(10);

<span class="bold"><strong>lib.refresh();</strong></span>
Expression expr = lib.compileExpression(query1);
ItemSequence results = expr.evaluate();

Thread.sleep(10000);

<span class="bold"><strong>lib.refresh();</strong></span>
expr = lib.compileExpression(query1);
ItemSequence results = expr.evaluate();

// this lock will wait as long as necessary:
Collection maps = <span class="bold"><strong>lib.lockCollection("/maps", -1)</strong></span>;
if (maps != null) { // null means deleted
    lib.importDocument(file1, "/maps/Germany.xml");
    lib.commit();
}

Thread.sleep(10000);

Document doc = <span class="bold"><strong>lib.lockDocument("/maps/Germany.xml", -1)</strong></span>;
if (doc != null) {
    doc.setProperty("lastModified", new Date());
    lib.commit();
}

lib.close();</pre><p>This being said, the recommended programming style is to use <span class="emphasis"><em>short-lived sessions</em></span>, and not long-lived sessions. That is, we recommend that a thread opens a <code class="interfacename">Library</code><sup>[<a name="d0e6187" href="#ftn.d0e6187" class="footnote">8</a>]</sup> and then closes it, each time it needs to access or modify this <code class="interfacename">Library</code>. In a nutshell:</p><div class="itemizedlist"><ul type="disc" compact><li><p>If you need to perform a query, simply open the <code class="interfacename">Library</code>, perform your query, then close the <code class="interfacename">Library</code>. No need to use <code class="methodname">refresh</code>.</p></li><li><p>If you need to modify a <code class="interfacename">Library</code>, simply open the <code class="interfacename">Library</code>, lock the ancestor <code class="interfacename">Collection</code> of all the <code class="interfacename">LibraryMember</code>s to be modified, perform your changes, commit them, then close the <code class="interfacename">Library</code>.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6228"></a>2.5.&nbsp;Compiling and running the code of this lesson</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">Put</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/put/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/put/</code> directory.</p></li><li><p>Create the "<code class="literal">Tutorial</code>" library and populate it with all the documents found in <code class="filename">docs/samples/book_data/</code> by running <span class="command"><strong>ant&nbsp;run</strong></span> in the <code class="filename">docs/samples/programming/put/</code> directory.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="lesson_get"></a>3.&nbsp;Retrieving Documents stored in a database</h2></div></div></div><p>The <code class="classname">Get</code> class implements a command-line tool allowing to make local copies of <code class="interfacename">Collection</code>s and <code class="interfacename">Document</code>s stored in a <code class="interfacename">Library</code>. This tool can match the names of the <code class="interfacename">Collection</code>s and <code class="interfacename">Document</code>s to be copied against a wildcard. For example, it can be used to make local copies all <code class="interfacename">Document</code>s whose names end with "<code class="literal">.xhtml</code>" found in the "<code class="literal">/Author&nbsp;Blurbs</code>" <code class="interfacename">Collection</code> (corresponding command-line argument is "<code class="literal">/Author Blurbs/*.xhtml</code>").</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>For queries to work properly, document imports and updates should first be completed with a commit. Some operations would work even before the commit (like getting the contents of a just imported document), but many operations rely on indexing, and indexing is completed at the time of the commit.</p></div><p>Excerpts of <a class="ulink" href="../samples/programming/get/Get.java" target="_top"><code class="filename">Get.java</code></a>:</p><pre class="programlisting">            ...
            LibraryMember libMember = lib.getMember(path);<a class="co" name="get_getMember" href="programming.html#get_getMember_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
            if (libMember == null) {
                error("dont't find '" + path + "'");
                return;
            }

            get(libMember, dstFile);
            ...

   private static void get(LibraryMember libMember, File dstFile) 
        throws IOException, QizxException {
        File dstFile2;
        if (dstFile.isDirectory()) {
            String baseName = libMember.getName();
            if ("/".equals(baseName))
                baseName = "root";

            dstFile2 = new File(dstFile, baseName);
        } else {
            dstFile2 = dstFile;
        }

        if (libMember.isCollection()) {<a class="co" name="get_isCollection" href="programming.html#get_isCollection_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
            getCollection((Collection) libMember, dstFile2);
        } else {
            getDocument((Document) libMember, dstFile2);
        }
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="get_getMember_2"></a><a href="#get_getMember"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Library.html#getMember(java.lang.String)" target="_top"><code class="methodname">Library.getMember</code></a> returns the <a class="ulink" href="../javadoc/com/qizx/api/LibraryMember.html" target="_top"><code class="interfacename">LibraryMember</code></a> (if any) corresponding to specified absolute path.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="get_isCollection_2"></a><a href="#get_isCollection"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/LibraryMember.html#isCollection()" target="_top"><code class="methodname">LibraryMember.isCollection</code></a> may be used to test if this member is a <code class="interfacename">Collection</code> or a <code class="interfacename">Document</code>. You'll also find a <a class="ulink" href="../javadoc/com/qizx/api/LibraryMember.html#isDocument()" target="_top"><code class="methodname">LibraryMember.isDocument</code></a> method.</p></td></tr></table></div><p>A local copy of a <code class="interfacename">Document</code> is created as follows:</p><pre class="programlisting">    private static void getDocument(Document doc, File dstFile) 
        throws IOException, QizxException {
        verbose("Copying document '" + doc.getPath() + 
                "' to file '" + dstFile + "'...");

        FileOutputStream out = new FileOutputStream(dstFile);
        try {
            doc.export(new XMLSerializer(out, "UTF-8"));<a class="co" name="get_export" href="programming.html#get_export_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        } finally {
            out.close();
        }
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="get_export_2"></a><a href="#get_export"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The <a class="ulink" href="../javadoc/com/qizx/api/Document.html#export(com.qizx.api.XMLPushStream)" target="_top"><code class="methodname">Document.export</code></a> method used in the above code sample has a <a class="ulink" href="../javadoc/com/qizx/api/XMLPushStream.html" target="_top"><code class="interfacename">XMLPushStream</code></a> parameter. That is, to export itself, a <code class="interfacename">Document</code> ``pushes its XML content'' (element tags, attributes, text, etc) to an object implementing the <code class="interfacename">XMLPushStream</code> interface.</p><p>Qizx comes with a number of useful implementations of the <code class="interfacename">XMLPushStream</code> interface:</p><div class="variablelist"><dl><dt><span class="term"><a class="ulink" href="../javadoc/com/qizx/api/util/XMLSerializer.html" target="_top"><code class="classname">com.qizx.api.util.XMLSerializer</code></a></span></dt><dd><p>Most useful implementation. It allows to save XML content to a <code class="interfacename">java.io.OutputStream</code> and thus, to a <code class="classname">File</code> or a <code class="classname">String</code>.</p></dd><dt><span class="term"><a class="ulink" href="../javadoc/com/qizx/api/util/PushStreamToDOM.html" target="_top"><code class="classname">com.qizx.api.util.PushStreamToDOM</code></a></span></dt><dd><p>With this implementation of <code class="interfacename">XMLPushStream</code>, converting a Qizx <code class="interfacename">Document</code> to <code class="interfacename">org.w3c.dom.Document</code> is as simple as:</p><pre class="programlisting">PushStreamToDOM toDOM = new PushStreamToDOM();
doc.export(toDOM);
org.w3c.dom.Document w3cDOMDoc = toDOM.getResultDocument();</pre></dd><dt><span class="term"><a class="ulink" href="../javadoc/com/qizx/api/util/PushStreamToSAX.html" target="_top"><code class="classname">com.qizx.api.util.PushStreamToSAX</code></a></span></dt><dd><p>With this implementation of <code class="interfacename">XMLPushStream</code>, feeding a Qizx <code class="interfacename">Document</code> into a SAX <code class="interfacename">org.xml.sax.ContentHandler</code> is as simple as:</p><pre class="programlisting">PushStreamToSAX toSAX = new PushStreamToSAX(handler);
doc.export(toSAX);</pre></dd></dl></div><p>The above <code class="methodname">export</code> method is useful when you want to save, or simply traverse, a <code class="interfacename">Document</code> stored in a <code class="interfacename">Library</code>. There is another <a class="ulink" href="../javadoc/com/qizx/api/Document.html#export()" target="_top"><code class="methodname">Document.export</code></a> method, this time having no parameters, which is useful when you want to <span class="emphasis"><em>parse</em></span> a <code class="interfacename">Document</code> stored in a <code class="interfacename">Library</code>. This alternate <code class="methodname">export</code> method returns an <a class="ulink" href="../javadoc/com/qizx/api/XMLPullStream.html" target="_top"><code class="interfacename">XMLPullStream</code></a>, that is, a <em class="firstterm">pull parser</em><sup>[<a name="d0e6464" href="#ftn.d0e6464" class="footnote">9</a>]</sup>, similar to a <a class="ulink" href="https://sjsxp.dev.java.net/" target="_top">StAX</a> parser.</p></td></tr></table></div><p>A local copy of a <code class="interfacename">Collection</code> is created as follows:</p><pre class="programlisting">    private static void getCollection(Collection col, File dstFile) 
        throws IOException, QizxException {
        verbose("Copying collection '" + col.getPath() + 
                "' to directory '" + dstFile + "'...");

        if (!dstFile.isDirectory()) {
            verbose("Creating directory '" + dstFile + "'...");

            if (!dstFile.mkdirs()) {
                throw new IOException("Cannot create directory '" + 
                                      dstFile + "'");
            }
        }

        <span class="bold"><strong>LibraryMemberIterator iter</strong></span> = col.getChildren();<a class="co" name="get_getChildren" href="programming.html#get_getChildren_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        while (<span class="bold"><strong>iter.moveToNextMember()</strong></span>) {
            LibraryMember libMember = <span class="bold"><strong>iter.getCurrentMember()</strong></span>;

            File dstFile2 = new File(dstFile, libMember.getName());
            
            if (libMember.isCollection()) {
                getCollection((Collection) libMember, dstFile2);
            } else {
                getDocument((Document) libMember, dstFile2);
            }
        }
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="get_getChildren_2"></a><a href="#get_getChildren"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Collection.html#getChildren()" target="_top"><code class="methodname">Collection.getChildren</code></a> returns an iterator which iterates over the <code class="interfacename">Collection</code>s and <code class="interfacename">Document</code>s directly contained in a <code class="interfacename">Collection</code>.</p><p>You'll also find a variant of the <a class="ulink" href="../javadoc/com/qizx/api/Collection.html#getChildren(com.qizx.api.LibraryMemberFilter)" target="_top"><code class="methodname">getChildren</code></a> method which has a <a class="ulink" href="../javadoc/com/qizx/api/LibraryMemberFilter.html" target="_top"><code class="interfacename">LibraryMemberFilter</code></a> parameter. <a class="ulink" href="../javadoc/com/qizx/api/util/GlobFilter.html" target="_top"><code class="classname">com.qizx.api.util.GlobFilter</code></a> is a ready-to-use implementation of <code class="interfacename">LibraryMemberFilter</code> which matches the name (not the full path, just the name) of a <code class="interfacename">LibraryMember</code> against a glob-style (Unix shell) pattern.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a name="about_qizx_iterators"></a>About Qizx iterators</h3><p>The Qizx API contains a number of iterators which work differently from <code class="interfacename">java.util.Iterator</code> (e.g. <code class="methodname">hasNext</code>, <code class="methodname">next</code>).</p><p>In the Qizx API, an iterator always has a <code class="methodname">moveToNext<em class="replaceable"><code>XXX</code></em></code> method which moves the position of the cursor by one item and a <code class="methodname">getCurrent<em class="replaceable"><code>XXX</code></em></code> which returns the item found at current cursor position.</p><p>Invoking <code class="methodname">getCurrent<em class="replaceable"><code>XXX</code></em></code> several times, without invoking <code class="methodname">moveToNext<em class="replaceable"><code>XXX</code></em></code>, is indeed possible and will always return the same item. However initially the cursor is one position before the first item (if any), therefore you need to invoke <code class="methodname">moveToNext<em class="replaceable"><code>XXX</code></em></code> at least once before invoking <code class="methodname">getCurrent<em class="replaceable"><code>XXX</code></em></code>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6581"></a>3.1.&nbsp;Compiling and running the code of this lesson</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">Get</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/get/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/get/</code> directory.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run</strong></span> in the <code class="filename">docs/samples/programming/get/</code> directory to make local copies of</p><div class="itemizedlist"><ul type="circle"><li><p><code class="interfacename">Document</code> "<code class="literal">/Authors/pjfarmer.xml</code>",</p></li><li><p><code class="interfacename">Document</code>s "<code class="literal">/Author Blurbs/Philip*</code>",</p></li><li><p><code class="interfacename">Document</code>s "<code class="literal">/Books/The*.xml</code>",</p></li><li><p><code class="interfacename">Collection</code> "<code class="literal">/Publishers</code>".</p></li></ul></div><p>in <code class="filename">docs/samples/programming/get/tests/out/</code>.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="lesson_query"></a>4.&nbsp;Querying a database</h2></div></div></div><p>Querying a database (that is, a <code class="interfacename">Library</code>) is fairly easy:</p><pre class="programlisting">Expression expr = lib.compileExpression(script);<a class="co" name="query_compileExpression" href="programming.html#query_compileExpression_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
ItemSequence results = expr.evaluate();<a class="co" name="query_evaluate" href="programming.html#query_evaluate_2"><img src="images/callouts/2.png" alt="2" border="0"></a>        
while (results.moveToNextItem()) {<a class="co" name="query_results" href="programming.html#query_results_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
    Item result = results.getCurrentItem();

    <em class="replaceable"><code>/*Do something with result.*/</code></em>
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="query_compileExpression_2"></a><a href="#query_compileExpression"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>First compile an XQuery expression using <a class="ulink" href="../javadoc/com/qizx/api/Library.html#compileExpression(java.lang.String)" target="_top"><code class="methodname">Library.compileExpression</code></a>. If no compilation errors (<a class="ulink" href="../javadoc/com/qizx/api/CompilationException.html" target="_top"><code class="classname">CompilationException</code></a>) are found, this returns an <a class="ulink" href="../javadoc/com/qizx/api/Expression.html" target="_top"><code class="interfacename">Expression</code></a> object.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="query_evaluate_2"></a><a href="#query_evaluate"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>Then evaluate the expression using <a class="ulink" href="../javadoc/com/qizx/api/Expression.html#evaluate()" target="_top"><code class="methodname">Expression.evaluate</code></a>. If no evaluation errors (<a class="ulink" href="../javadoc/com/qizx/api/EvaluationException.html" target="_top"><code class="classname">EvaluationException</code></a>) are found, this returns the results of the evaluation in the form of an <a class="ulink" href="../javadoc/com/qizx/api/ItemSequence.html" target="_top"><code class="interfacename">ItemSequence</code></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="query_results_2"></a><a href="#query_results"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>An <code class="interfacename">ItemSequence</code> allows to iterate over a sequence of <code class="interfacename">Item</code>s (see <a class="xref" href="programming.html#about_qizx_iterators" title="About Qizx iterators">About Qizx iterators</a>). A <a class="ulink" href="../javadoc/com/qizx/api/Item.html" target="_top"><code class="interfacename">Item</code></a> is either an atomic value or an XML <a class="ulink" href="../javadoc/com/qizx/api/Node.html" target="_top"><code class="interfacename">Node</code></a>.</p><p>Example (<a class="ulink" href="../samples/book_queries/1.xq" target="_top"><code class="filename">1.xq</code></a>):</p><pre class="programlisting"><span class="emphasis"><em>(: Compute and return 2 + 3 :)</em></span>
2 + 3</pre><p>evaluates to an <code class="interfacename">ItemSequence</code> containing a single atomic value (5).</p><p>Example (<a class="ulink" href="../samples/book_queries/3.xq" target="_top"><code class="filename">3.xq</code></a>):</p><pre class="programlisting"><span class="emphasis"><em>(: List all books by their titles. :)</em></span>
declare namespace t = "http://www.qizx.com/namespace/Tutorial";

collection("/Books")//t:book/t:title</pre><p>evaluates to an <code class="interfacename">ItemSequence</code> containing several <code class="sgmltag-attribute">t:title</code> element <code class="interfacename">Node</code>s.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>For queries to work properly, document imports and updates should first be completed with a commit. Some operations would work even before the commit (like getting the contents of a just imported document), but many operations rely on indexing, and indexing is completed at the time of the commit.</p></div><p>The <code class="classname">Query</code> class, which implements a command-line tool allowing to query a <code class="interfacename">Library</code>, is more complicated than the above code sample because it supports somewhat advanced options.</p><p>Excerpts of <a class="ulink" href="../samples/programming/query/Query.java" target="_top"><code class="filename">Query.java</code></a>:</p><pre class="programlisting">    private static Expression compileExpression(Library lib, 
                                                String script,
                                                LibraryMember queryRoot,
                                                QName[] varNames,
                                                String[] varValues) 
        throws IOException, QizxException {
        Expression expr;
        try {
            expr = lib.compileExpression(script);
        } catch (CompilationException e) {
            Message[] messages = e.getMessages();
            for (int i = 0; i &lt; messages.length; ++i) {
                error(messages[i].toString());
            }

            throw e;
        }

        if (queryRoot != null)
            expr.bindImplicitCollection(queryRoot);<a class="co" name="query_bindImplicitCollection" href="programming.html#query_bindImplicitCollection_2"><img src="images/callouts/1.png" alt="1" border="0"></a>

        if (varNames != null) {
            for (int i = 0; i &lt; varNames.length; ++i) {
                expr.bindVariable(varNames[i], varValues[i], /*type*/ null);<a class="co" name="query_bindVariable" href="programming.html#query_bindVariable_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
            }
        }

        return expr;
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="query_bindImplicitCollection_2"></a><a href="#query_bindImplicitCollection"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Expression.html#bindImplicitCollection(com.qizx.api.LibraryMember)" target="_top"><code class="methodname">Expression.bindImplicitCollection</code></a> allows to write queries containing paths which are not prefixed with <code class="literal">collection("<em class="replaceable"><code>XXX</code></em>")</code> or <code class="literal">doc("<em class="replaceable"><code>YYY</code></em>")</code>.</p><p>Example (<a class="ulink" href="../samples/book_queries/100.xq" target="_top"><code class="filename">100.xq</code></a>), using <code class="methodname">bindImplicitCollection</code> to bind the expression to <code class="literal">collection("/Books")</code>, allows to write:</p><pre class="programlisting"><span class="emphasis"><em>(: List all books by their titles. :)</em></span>
declare namespace t = "http://www.qizx.com/namespace/Tutorial";

//t:book/t:title</pre><p>instead of (<a class="ulink" href="../samples/book_queries/3.xq" target="_top"><code class="filename">3.xq</code></a>):</p><pre class="programlisting"><span class="emphasis"><em>(: List all books by their titles. :)</em></span>
declare namespace t = "http://www.qizx.com/namespace/Tutorial";

collection("/Books")//t:book/t:title</pre></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="query_bindVariable_2"></a><a href="#query_bindVariable"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>An XQuery expression can be further parametrized by the use of variables. Example (<a class="ulink" href="../samples/book_queries/101.xq" target="_top"><code class="filename">101.xq</code></a>):</p><pre class="programlisting"><span class="emphasis"><em>(: List all books containing the value of variable $searched 
   in their titles. :)</em></span>
declare namespace t = "http://www.qizx.com/namespace/Tutorial";

<span class="bold"><strong>declare variable $searched external;</strong></span>

collection("/Books")//t:book/t:title[contains(., <span class="bold"><strong>$searched</strong></span>)]</pre><p><a class="ulink" href="../javadoc/com/qizx/api/Expression.html#bindVariable(com.qizx.api.QName,%20java.lang.Object,%20com.qizx.api.ItemType)" target="_top"><code class="methodname">Expression.bindVariable</code></a> allows to give a variable its value, prior to evaluating the expression.</p></td></tr></table></div><p>Some queries may return thousands of results. Therefore, displaying just a range of results (e.g. from result #100 to result #199 inclusive) is a very common need.</p><pre class="programlisting">    private static void evaluateExpression(Expression expr, 
                                           int from, int limit) 
        throws QizxException {
        ItemSequence results = expr.evaluate();
        if (from &gt; 0) {
            results.skip(from);<a class="co" name="query_skip" href="programming.html#query_skip_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        }

        XMLSerializer serializer = new XMLSerializer();
        serializer.setIndent(2);

        int count = 0;
        while (results.moveToNextItem()) {
            Item result = results.getCurrentItem();

            System.out.print("[" + (from+1+count) + "] ");
            showResult(serializer, result);
            System.out.println();

            ++count;
            if (count &gt;= limit)<a class="co" name="query_limit" href="programming.html#query_limit_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
                break;
        }
        System.out.flush();
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="query_skip_2"></a><a href="#query_skip"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/ItemSequence.html#skip(int)" target="_top"><code class="methodname">ItemSequence.skip</code></a> allows to quickly skip the specified number of <code class="interfacename">Item</code>s.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="query_limit_2"></a><a href="#query_limit"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>This being done, you still need to limit the number of <code class="interfacename">Item</code>s you are going to display.</p></td></tr></table></div><p>In this lesson, we'll just show how to print the string representation of an <code class="interfacename">Item</code>. In <a class="link" href="programming.html#lesson_edit" title="6.&nbsp;Modifying a Document stored in a database">lesson 5</a>, we'll go further and explore the data model of Qizx.</p><pre class="programlisting">    private static void showResult(XMLSerializer serializer,
                                   Item result) 
        throws QizxException {
        if (!result.isNode()) {<a class="co" name="query_isNode" href="programming.html#query_isNode_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
            System.out.println(result.getString());<a class="co" name="query_getString" href="programming.html#query_getString_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
            return;
        }
        Node node = result.getNode();<a name="query_getNode"></a><img src="images/callouts/3.png" alt="3" border="0">

        serializer.reset();
        String xmlForm = serializer.serializeToString(node);<a class="co" name="query_serializeToString" href="programming.html#query_serializeToString_2"><img src="images/callouts/4.png" alt="4" border="0"></a>
        System.out.println(xmlForm);
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="query_isNode_2"></a><a href="#query_isNode"><img src="images/callouts/1.png" alt="1" border="0"></a> <a href="#query_getNode"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Item.html#isNode()" target="_top"><code class="methodname">Item.isNode</code></a> returns <code class="literal">true</code> for a <code class="interfacename">Node</code> and <code class="literal">false</code> for an atomic value. Similarly, <a class="ulink" href="../javadoc/com/qizx/api/Item.html#getNode()" target="_top"><code class="methodname">Item.getNode</code></a> returns a <code class="interfacename">Node</code> when the <code class="interfacename">Item</code> actually is a Node and <code class="literal">null</code> when the <code class="interfacename">Item</code> is an atomic value.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="query_getString_2"></a><a href="#query_getString"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Item.html#getString()" target="_top"><code class="methodname">Item.getString</code></a> returns the <em class="firstterm">string value</em> of an <code class="interfacename">Item</code> (whether <code class="interfacename">Node</code> or atomic value). What precisely is the string value of an <code class="interfacename">Item</code> is specified in the <a class="ulink" href="http://www.w3.org/TR/xquery/#id-typed-value" target="_top">XQuery standard</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="query_serializeToString_2"></a><a href="#query_serializeToString"><img src="images/callouts/4.png" alt="4" border="0"></a> </p></td><td valign="top" align="left"><p>The <a class="ulink" href="../javadoc/com/qizx/api/util/XMLSerializer.html#serializeToString(com.qizx.api.Node)" target="_top"><code class="methodname">XMLSerializer.serializeToString</code></a> convenience method is used to obtain the string representation of a <code class="interfacename">Node</code>.</p></td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6948"></a>4.1.&nbsp;Compiling and running the code of this lesson</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">Query</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/query/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/query/</code> directory.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run</strong></span> in the <code class="filename">docs/samples/programming/query/</code> directory to perform this query:</p><pre class="programlisting"><span class="emphasis"><em>(: Find all books written by French authors. :)</em></span>
declare namespace t = "http://www.qizx.com/namespace/Tutorial";

for $a in collection("/Authors")//t:author[@nationality = "France"]
    for $b in collection("/Books")//t:book[.//t:author = $a/t:fullName]
    return 
        $b/t:title</pre><p>Note that directory <a class="ulink" href="../samples/book_queries/" target="_top"><code class="filename">docs/samples/book_queries/</code></a> contains all the queries needed to illustrate this lesson and also the following ones. You can execute all these queries by running <span class="command"><strong>ant&nbsp;run_all</strong></span> in <code class="filename">docs/samples/programming/query/</code>.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="lesson_delete"></a>5.&nbsp;Deleting Documents and Collections</h2></div></div></div><p>Class <code class="classname">Delete</code> implements a command-line tool allowing to delete one or more <code class="classname">Document</code>s or <code class="classname">Collection</code>s. If no <code class="classname">Document</code> or <code class="classname">Collection</code> paths are specified as command-line arguments, the tool deletes the whole <code class="classname">Library</code>.</p><p>Excerpts of <a class="ulink" href="../samples/programming/delete/Delete.java" target="_top"><code class="filename">Delete.java</code></a>:</p><pre class="programlisting">        if (args.length == 2) {
            verbose("Deleting library '" + libName + "'...");
            if (!libManager.deleteLibrary(libName)) {<a class="co" name="delete_deleteLibrary" href="programming.html#delete_deleteLibrary_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
                warning("Library '" + libName + "' not found");
            }
            libManager.closeAllLibraries(10000 /*ms*/);
        } else {
            Library lib = libManager.openLibrary(libName);

            try {
                for (int i = 2; i &lt; args.length; ++i) {
                    String path = args[i];

                    verbose("Deleting member '" + path + "' of library '" + 
                            libName + "'...");
                    if (!lib.deleteMember(path)) {<a class="co" name="delete_deleteMember" href="programming.html#delete_deleteMember_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
                        warning("Member '" + path + "' of library '" + 
                                libName + "' not found");
                    }
                }

                verbose("Committing changes...");
                lib.commit();
            } finally {
                shutdown(lib, libManager);
            }
        }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="delete_deleteLibrary_2"></a><a href="#delete_deleteLibrary"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html#deleteLibrary(java.lang.String)" target="_top"><code class="methodname">LibraryManager.deleteLibrary</code></a> is used to delete a <code class="interfacename">Library</code>. Note that the <code class="methodname">commit</code> method is not invoked in this case.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="delete_deleteMember_2"></a><a href="#delete_deleteMember"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Library.html#deleteMember(java.lang.String)" target="_top"><code class="methodname">Library.deleteMember</code></a> is used to delete a <code class="interfacename">LibraryMember</code> (<code class="interfacename">Document</code> or <code class="interfacename">Collection</code>). <code class="interfacename">Collection</code>s are recursively deleted.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a name="delete_LibraryManager"></a>How to delete a <code class="interfacename">LibraryManager</code></h3><p>Because there is no <code class="methodname">LibraryManager.delete</code> method, the only way to physically destroy a <a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html" target="_top"><code class="interfacename">LibraryManager</code></a> is, first to ``close'' it using <a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html#closeAllLibraries(int)" target="_top"><code class="methodname">LibraryManager.closeAllLibraries</code></a>, and then, to delete its storage directory (obtained using <a class="ulink" href="../javadoc/com/qizx/api/LibraryManager.html#getStorageDirectory()" target="_top"><code class="methodname">LibraryManager.getStorageDirectory</code></a>).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7081"></a>5.1.&nbsp;Compiling and running the code of this lesson</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">Delete</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/delete/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/delete/</code> directory.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run</strong></span> in the <code class="filename">docs/samples/programming/delete/</code> directory to delete <code class="interfacename">Document</code> "<code class="literal">/Authors/ktrout.xml</code>"<sup>[<a name="ktrout" href="#ftn.ktrout" class="footnote">10</a>]</sup>.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="lesson_edit"></a>6.&nbsp;Modifying a Document stored in a database</h2></div></div></div><p>Since Qizx 2.1, there are two methods for updating a document:</p><div class="orderedlist"><ol type="1"><li><p>Use <a class="ulink" href="http://www.w3.org/TR/xquery-update-10/" target="_top">XQuery Update</a>, an extension to XQuery that allows insertions, deletions and updates on selected nodes. This is in general by far the easiest method.</p><p>A tutorial is <a class="ulink" href="http://www.xmlmind.com/_tutorials/XQueryUpdate/index.html" target="_top">available here</a> for a quick yet comprehensive introduction to XQuery Update.</p></li><li><p>Extract the document to update as a W3C <acronym class="acronym">DOM</acronym> <code class="interfacename">Document</code>, then update the DOM form, then write back the DOM onto the document. This was the only method available in Qizx 2.0. It can still be useful in specific cases.</p></li></ol></div><p>Whatever method is used, please remember that any update operation on a document basically implies replacing the document in its entirety. This corresponds with a deliberate design choice allowing faster queries.</p><p>In the next sections, the two methods are explained. The example described consists of adding a pseudonym to an existing author specified by his/her full name.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7153"></a>6.1.&nbsp;Updating a Document using XQuery Update</h3></div></div></div><p>XQuery Update is an extension of XQuery which provides additional instructions for updating documents. The updating primitives are <span class="command"><strong>insert</strong></span>, <span class="command"><strong>delete</strong></span>, <span class="command"><strong>replace</strong></span> and <span class="command"><strong>rename</strong></span>.</p><p>Using XQuery Update simply consists of executing a script containing XQuery Update primitives. Such a script is called an <em class="glossterm">updating query</em>.</p><p>An "updating query" is executed in a special way by the XQuery engine:</p><div class="itemizedlist"><ul type="disc"><li><p>first a "<em class="glossterm">pending update list</em>" is created by executing the query (which returns no value)</p></li><li><p>then the update list is applied at once.</p></li></ul></div><p>This means that changes are not visible <span class="emphasis"><em>during the execution</em></span> of the script, but only after completion. This can be surprising, as noted in the example hereafter. The <a class="ulink" href="http://www.xmlmind.com/_tutorials/XQueryUpdate/index.html" target="_top">XQuery Update tutorial</a> addresses such issues with more detail.</p><p>Here is the XQuery Update script used:</p><pre class="programlisting">declare default element namespace 'http://www.qizx.com/namespace/Tutorial';
declare variable $ERR := qName('http://www.w3.org/2005/xqt-errors', 'ERR00001');
declare variable $authorName external;
declare variable $pseudo external;

let $auth := /author[fullName = $authorName]
return
 if (empty($auth))
   then error($ERR, 'no such author')
 else if ($auth/pseudonyms[pseudonym = $pseudo]) <a class="co" name="xqup_findAuthor" href="programming.html#xqup_findAuthor2"><img src="images/callouts/1.png" alt="1" border="0"></a>
   then error($ERR, 'pseudonym already defined')
 else if ($auth/pseudonyms)
   then insert node &lt;pseudonym&gt;{ $pseudo }&lt;/pseudonym&gt; <a class="co" name="xqup_insertSimple" href="programming.html#xqup_insertSimple2"><img src="images/callouts/2.png" alt="2" border="0"></a>
          into $auth/pseudonyms
   else insert node &lt;pseudonyms&gt;&lt;pseudonym&gt;{ $pseudo }&lt;/pseudonym&gt;&lt;/pseudonyms&gt; <a class="co" name="xqup_insert" href="programming.html#xqup_insert2"><img src="images/callouts/3.png" alt="3" border="0"></a>
          into $auth</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="xqup_findAuthor2"></a><a href="#xqup_findAuthor"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>Preliminary tests: check that the author exists and that the pseudonym is not yet defined.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="xqup_insertSimple2"></a><a href="#xqup_insertSimple"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>If the enclosing element <code class="sgmltag-element">pseudonyms</code> exists, then we can directly insert the new <code class="sgmltag-element">pseudonym</code> element into it.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="xqup_insert2"></a><a href="#xqup_insert"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>If the element <code class="sgmltag-element">pseudonyms</code> does not exist yet, then create one with the new <code class="sgmltag-element">pseudonym</code> element inside it.</p><p>Please notice that due to the way XQuery Update works, it not possible to create the element <code class="sgmltag-element">pseudonyms</code> first, <span class="emphasis"><em>then</em></span> to insert the new <code class="sgmltag-element">pseudonym</code> element inside it. This is because the element <code class="sgmltag-element">pseudonyms</code> is not visible until completion, therefore it cannot be used by an expression <code class="code">insert node ... into</code>.</p></td></tr></table></div><p>The corresponding Java program is <a class="ulink" href="../samples/programming/edit/XUpdate.java" target="_top"><code class="filename">XUpdate.java</code></a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e7250"></a>6.1.1.&nbsp;Compiling and running the code of this lesson</h4></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">XUpdate</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/edit/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/edit/</code> directory.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;xurun</strong></span> in the <code class="filename">docs/samples/programming/edit/</code> directory to add pseudonym "<code class="literal">Kilgore Trout</code>" to author "<code class="literal">Philip Jos&eacute; Farmer</code>" <sup>[<a href="programming.html#ftn.ktrout" class="footnoteref">10</a>]</sup>.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7287"></a>6.2.&nbsp;Updating a Document using the Java API and DOM</h3></div></div></div><p>The strategy we'll use is the following:</p><div class="orderedlist"><ol type="1"><li><p>Find the <code class="interfacename">Document</code> to be modified by performing a query.</p></li><li><p>Convert the document <code class="interfacename">found</code> to a W3C <acronym class="acronym">DOM</acronym> <code class="interfacename">Document</code>. This step is needed because the <acronym class="acronym">DOM</acronym><sup>[<a name="d0e7313" href="#ftn.d0e7313" class="footnote">11</a>]</sup> of Qizx is immutable. For example, you'll find a <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getAttribute(com.qizx.api.QName)" target="_top"><code class="methodname">Node.getAttribute</code></a> method, but no <code class="methodname">Node.setAttribute</code> method.</p></li><li><p>Modify the W3C <acronym class="acronym">DOM</acronym> <code class="interfacename">Document</code>.</p></li><li><p>Replace the content of the <code class="interfacename">Document</code> stored in the <code class="interfacename">Library</code> by the content of the W3C <acronym class="acronym">DOM</acronym> <code class="interfacename">Document</code>.</p></li></ol></div><p>Unlike the <code class="methodname">Put</code>, <code class="methodname">Get</code>, <code class="methodname">Delete</code> classes which implement generic command-line tools, the <code class="methodname">Edit</code> class is specific to the dataset used to illustrate this tutorial. The <code class="methodname">Edit</code> class allows to add a pseudonym to an author. The author is found by her/his full name, and not by the path of the <code class="interfacename">Document</code> containing her/his record.</p><p>Excerpts of <a class="ulink" href="../samples/programming/edit/Edit.java" target="_top"><code class="filename">Edit.java</code></a>:</p><pre class="programlisting">        Node author = findAuthor(lib, collectionPath, authorName);<a class="co" name="edit_findAuthor" href="programming.html#edit_findAuthor_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        if (author == null)
            return;

        if (hasPseudonym(author, pseudonym)) {<a class="co" name="edit_hasPseudonym" href="programming.html#edit_hasPseudonym_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
            warning("'" + authorName + "' already has pseudonym '" + 
                    pseudonym + "'");
            return;
        }

        org.w3c.dom.Document doc = 
            (org.w3c.dom.Document) author.getDocumentNode()<a class="co" name="edit_getDocumentNode" href="programming.html#edit_getDocumentNode_2"><img src="images/callouts/3.png" alt="3" border="0"></a>.getObject();<a class="co" name="edit_getObject" href="programming.html#edit_getObject_2"><img src="images/callouts/4.png" alt="4" border="0"></a>
        if (!doAddPseudo(doc, pseudonym))<a class="co" name="edit_doAddPseudo" href="programming.html#edit_doAddPseudo_2"><img src="images/callouts/5.png" alt="5" border="0"></a>
            return;

        XMLPushStream out = 
            lib.beginImportDocument(author.getLibraryDocument()<a class="co" name="edit_getLibraryDocument" href="programming.html#edit_getLibraryDocument_2"><img src="images/callouts/6.png" alt="6" border="0"></a>.getPath());<a class="co" name="edit_beginImportDocument" href="programming.html#edit_beginImportDocument_2"><img src="images/callouts/7.png" alt="7" border="0"></a>

        DOMToPushStream helper = new DOMToPushStream(lib, out);<a class="co" name="edit_DOMToPushStream" href="programming.html#edit_beginImportDocument_2"><img src="images/callouts/8.png" alt="8" border="0"></a>
        helper.putDocument(doc);
        lib.endImportDocument();</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="edit_findAuthor_2"></a><a href="#edit_findAuthor"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The <code class="methodname">findAuthor</code> method allows to find an <code class="sgmltag-element">t:author</code> element by the content of its <code class="sgmltag-element">t:fullName</code> child element. <a class="link" href="programming.html#lesson_query" title="4.&nbsp;Querying a database">Lesson 3</a> explained how to query a database, so there is nothing new here:</p><pre class="programlisting">    private static Node findAuthor(Library lib, String collectionPath,
                                   String authorName) 
        throws QizxException {
        Collection collection = lib.getCollection(collectionPath);
        if (collection == null) {
            error("'" + collectionPath + "' is not a collection");
            return null;
        }

        String script = 
            "declare namespace t = '" + TUTORIAL_NS_URI + "';\n" +
            "declare variable $name external;\n" +
            "/t:author[t:fullName = $name]";

        Expression expr = <span class="bold"><strong>lib.compileExpression</strong></span>(script);
        expr.bindImplicitCollection(collection);
        expr.bindVariable(lib.getQName("name"), authorName, /*type*/ null);

        ItemSequence items = <span class="bold"><strong>expr.evaluate</strong></span>();
        if (!<span class="bold"><strong>items.moveToNextItem</strong></span>()) {
            error("Don't find author '" + authorName + "'");
            return null;
        }
        Item item = <span class="bold"><strong>items.getCurrentItem</strong></span>();

        return item.getNode();
    }</pre></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_hasPseudonym_2"></a><a href="#edit_hasPseudonym"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>The <code class="methodname">hasPseudonym</code> method is detailed <a class="link" href="programming.html#edit_hasPseudonym_code">below</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_getDocumentNode_2"></a><a href="#edit_getDocumentNode"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>Method <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getDocumentNode()" target="_top"><code class="methodname">Node.getDocumentNode</code></a> is used to access the document <code class="interfacename">Node</code> containing the <code class="sgmltag-element">t:author</code> element <code class="interfacename">Node</code> previously found by the <code class="methodname">findAuthor</code> method.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_getObject_2"></a><a href="#edit_getObject"><img src="images/callouts/4.png" alt="4" border="0"></a> </p></td><td valign="top" align="left"><p>Method <a class="ulink" href="???" target="_top"><code class="methodname">Item.getObject</code></a> converts an <code class="interfacename">Item</code> to an equivalent <span class="trademark">Java</span>&#8482; <code class="classname">Object</code>. In the case of a <code class="interfacename">com.qizx.api.Node</code>, this equivalent is a <code class="interfacename">org.w3c.dom.Node</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_doAddPseudo_2"></a><a href="#edit_doAddPseudo"><img src="images/callouts/5.png" alt="5" border="0"></a> </p></td><td valign="top" align="left"><p>The <code class="methodname">doAddPseudo</code> method adds a <code class="sgmltag-element">t:pseudonym</code> descendant to the <code class="sgmltag-element">t:author</code> element using the <span class="package">org.w3c.dom</span> API, which is standard <span class="trademark">Java</span>&#8482; since version 1.4.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_getLibraryDocument_2"></a><a href="#edit_getLibraryDocument"><img src="images/callouts/6.png" alt="6" border="0"></a> </p></td><td valign="top" align="left"><p>We now need to access the <code class="interfacename">Document</code>, that is, the <code class="interfacename">LibraryMember</code>, containing the <code class="sgmltag-element">t:author</code> element <code class="interfacename">Node</code>. Method <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getLibraryDocument()" target="_top"><code class="methodname">Node.getLibraryDocument</code></a> returns this information. Not to be confused with <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getDocumentNode()" target="_top"><code class="methodname">Node.getDocumentNode</code></a>, which returns the outermost ancestor <code class="interfacename">Node</code> of a <code class="interfacename">Node</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_beginImportDocument_2"></a><a href="#edit_beginImportDocument"><img src="images/callouts/7.png" alt="7" border="0"></a> <a href="#edit_DOMToPushStream"><img src="images/callouts/8.png" alt="8" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Library.html#beginImportDocument(java.lang.String)" target="_top"><code class="methodname">Library.beginImportDocument</code></a>, <a class="ulink" href="../javadoc/com/qizx/api/Library.html#endImportDocument()" target="_top"><code class="methodname">Library.endImportDocument</code></a> and the <a class="ulink" href="../javadoc/com/qizx/api/util/DOMToPushStream.html" target="_top"><code class="classname">com.qizx.api.util.DOMToPushStream</code></a> helper class allows to import a W3C <acronym class="acronym">DOM</acronym> Document into a <code class="interfacename">Library</code>. This has already been explained in <a class="link" href="programming.html#put_importDocument_2">lesson 1</a>.</p></td></tr></table></div><p><a name="edit_hasPseudonym_code"></a>The <code class="methodname">hasPseudonym</code> method is a simple example of using the Qizx <acronym class="acronym"><acronym class="acronym">DOM</acronym></acronym>. It searches its pseudonym argument inside an <code class="sgmltag-element">t:author</code>/<code class="sgmltag-element">t:pseudonyms</code>/<code class="sgmltag-element">t:pseudonym</code> element (author having multiple pseudonyms) or inside a <code class="sgmltag-element">t:author</code>/<code class="sgmltag-element">t:pseudonym</code> element (author having a single pseudonym):</p><pre class="programlisting">    private static boolean hasPseudonym(Node element, String pseudonym) 
        throws QizxException {
        Node child = element.getFirstChild();<a class="co" name="edit_getFirstChild" href="programming.html#edit_getFirstChild_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        while (child != null) {
            if (child.isElement()) {<a class="co" name="edit_isElement" href="programming.html#edit_isElement_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
                String childName = child.getNodeName().getLocalPart();<a class="co" name="edit_getNodeName" href="programming.html#edit_getNodeName_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
                if ("pseudonyms".equals(childName)) {
                    return hasPseudonym(child, pseudonym);
                } else if ("pseudonym".equals(childName)) {
                    if (pseudonym.equals(child.getStringValue())) {
                        return true;
                    }
                }
            }

            child = child.getNextSibling();<a name="edit_getNextSibling"></a><img src="images/callouts/4.png" alt="4" border="0">
        }

        return false;
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="edit_getFirstChild_2"></a><a href="#edit_getFirstChild"><img src="images/callouts/1.png" alt="1" border="0"></a> <a href="#edit_getNextSibling"><img src="images/callouts/4.png" alt="4" border="0"></a> </p></td><td valign="top" align="left"><p>The <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getFirstChild()" target="_top"><code class="methodname">Node.getFirstChild</code></a> and <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getNextSibling()" target="_top"><code class="methodname">Node.getNextSibling</code></a> methods allow to iterate over the children of an element or document <code class="interfacename">Node</code>.</p><p>Attributes are represented by <code class="interfacename">Node</code>s too, but are not considered to be children of element <code class="interfacename">Node</code>s. Attributes are accessed using the <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getAttribute(com.qizx.api.QName)" target="_top"><code class="methodname">Node.getAttribute</code></a>, <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getAttributeCount()" target="_top"><code class="methodname">Node.getAttributeCount</code></a>, <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getAttributes()" target="_top"><code class="methodname">Node.getAttributes</code></a> methods.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_isElement_2"></a><a href="#edit_isElement"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p><code class="interfacename">Node</code>s are not typed. That is, there are no <code class="interfacename">Element</code>, <code class="interfacename">Attribute</code>, <code class="interfacename">Comment</code>, etc, objects. The same <code class="interfacename">Node</code> object is used to represent an element, an attribute, a comment, a processing instruction, a text node or a document.</p><p>Method <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getNodeNature()" target="_top"><code class="methodname">Node.getNodeNature</code></a> returns the kind of a <code class="interfacename">Node</code>. <a class="ulink" href="../javadoc/com/qizx/api/Node.html#isElement()" target="_top"><code class="methodname">Node.isElement</code></a> is just a convenience method.</p><p>Methods such as <code class="methodname">Node.getName</code>, <code class="methodname">Node.getAttribute</code>, etc, return values depending on the kind of the subject <code class="interfacename">Node</code>. For example, <code class="methodname">Node.getAttribute</code> returns <code class="literal">null</code> for all kinds of <code class="interfacename">Node</code>s, except for element <code class="interfacename">Node</code>s.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="edit_getNodeName_2"></a><a href="#edit_getNodeName"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>An element <code class="interfacename">Node</code> has a name which is returned by the <a class="ulink" href="../javadoc/com/qizx/api/Node.html#getNodeName()" target="_top"><code class="methodname">Node.getName</code></a> method. In Qizx, an XML name is represented by a <a class="ulink" href="../javadoc/com/qizx/api/QName.html" target="_top"><code class="interfacename">com.qizx.api.QName</code></a><sup>[<a name="d0e7680" href="#ftn.d0e7680" class="footnote">12</a>]</sup> object, and not by a <code class="classname">String</code> or a pair of <code class="classname">String</code>s like in the W3C <acronym class="acronym">DOM</acronym>.</p><p>A new <code class="interfacename">QName</code> object is obtained using <a class="ulink" href="../javadoc/com/qizx/api/ItemFactory.html#getQName(java.lang.String,%20java.lang.String)" target="_top"><code class="methodname">ItemFactory.getQName</code></a>. A <code class="interfacename">Library</code> extends the <code class="interfacename">ItemFactory</code> interface. Therefore, a <code class="interfacename">QName</code> is generally obtained from a <code class="interfacename">Library</code>.</p></td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e7720"></a>6.2.1.&nbsp;Compiling and running the code of this lesson</h4></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">Edit</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/edit/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/edit/</code> directory.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run</strong></span> in the <code class="filename">docs/samples/programming/edit/</code> directory to add pseudonym "<code class="literal">Kilgore Trout</code>" to author "<code class="literal">Philip Jos&eacute; Farmer</code>" <sup>[<a href="programming.html#ftn.ktrout" class="footnoteref">10</a>]</sup>.</p><p>Note that if you have already run the example using XQuery Update, you will get an error since the Edit class does not accept duplicate pseudonyms.</p></li></ul></div></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="lesson_reindex"></a>7.&nbsp;Customizing the indexing of XML content</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7762"></a>7.1.&nbsp;Re-indexing a Library</h3></div></div></div><p>Query <a class="ulink" href="../samples/book_queries/20.xq" target="_top"><code class="filename">20.xq</code></a>:</p><pre class="programlisting"><span class="emphasis"><em>(: Find all authors born after 1945 (e.g. Lois McMaster Bujold). :)</em></span>
declare namespace t = "http://www.qizx.com/namespace/Tutorial";

collection("/")//t:author[<span class="bold"><strong>t:birthDate</strong></span> &gt; xs:date("1945-01-01Z")]/t:fullName</pre><p>gives no result because the <code class="sgmltag-element">t:birthDate</code> element is not indexed as a <code class="literal">xs:date</code><sup>[<a name="reindex_ant_run2" href="#ftn.reindex_ant_run2" class="footnote">13</a>]</sup>. The cause of this problem is that the element contains a date in local format (example: <code class="literal">November 2, 1949</code>) rather than a standard format (example: <code class="literal">1949-11-02</code>).</p><p>This is a case where we need to specify a custom indexing: on the <code class="sgmltag-element">t:birthDate</code> element, a specific string-to-date converter based on the predefined class <a class="ulink" href="../javadoc/com/qizx/api/util/text/FormatDateSieve.html" target="_top"><code class="classname">com.qizx.api.util.text.FormatDateSieve</code></a> has to be used.</p><p>In Qizx, custom indexing is defined through an "Indexing Specification" which is in XML format. The syntax and semantics of indexing specifications are described in great details in <a class="xref" href="indexing.html" title="Chapter&nbsp;9.&nbsp;Configuring the indexing process">Chapter&nbsp;9, <i>Configuring the indexing process</i></a>.</p><p>The indexing specification we will use is in the file <a class="ulink" href="../samples/programming/reindex/indexing.xml" target="_top"><code class="filename">indexing.xml</code></a>:</p><pre class="programlisting">&lt;indexing xmlns:t="http://www.qizx.com/namespace/Tutorial"&gt;
  <span class="emphasis"><em>&lt;!-- Default rules --&gt;</em></span><a class="co" name="reindex_default_rules" href="programming.html#reindex_default_rules_2"><img src="images/callouts/1.png" alt="1" border="0"></a>

  &lt;element as="numeric+string"/&gt;
  &lt;element as="date+string" /&gt;
  &lt;element as="string" /&gt;

  &lt;attribute as="numeric+string" /&gt;
  &lt;attribute as="date+string" /&gt;
  &lt;attribute as="string" /&gt;

  <span class="emphasis"><em>&lt;!-- Custom rules --&gt;</em></span>

  &lt;element name="t:birthDate" context="t:author" 
           as="date" sieve="com.qizx.api.util.text.FormatDateSieve" 
           format="MMMM d, yyyy" locale="en-US" timezone="GMT" /&gt;<a class="co" name="reindex_custom_date" href="programming.html#reindex_custom_date_2"><img src="images/callouts/2.png" alt="2" border="0"></a>

  &lt;element name="t:publicationDate" context="t:book" 
           as="numeric" sieve="RomanNumberSieve" /&gt;<a class="co" name="reindex_custom_number" href="programming.html#reindex_custom_number_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
&lt;/indexing&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="reindex_default_rules_2"></a><a href="#reindex_default_rules"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>Including the default rules before your custom rules is mandatory. If you don't do that, the Library is re-indexed with just the custom rules, which means that many queries will not work.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="reindex_custom_date_2"></a><a href="#reindex_custom_date"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>This custom rule specifies that a <code class="classname">FormatDateSieve</code> with a US "<code class="literal">MMMM d, yyyy</code>" format is to be used to index the content of <code class="sgmltag-element">t:author</code>/<code class="sgmltag-element">t:birthDate</code> elements.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="reindex_custom_number_2"></a><a href="#reindex_custom_number"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>More about this other custom rule in <a class="xref" href="programming.html#reindex_custom_sieve" title="7.2.&nbsp;Writing a custom Indexing.NumberSieve">Section&nbsp;7.2, &#8220;Writing a custom Indexing.NumberSieve&#8221;</a>.</p></td></tr></table></div><p>The <code class="classname">ReIndex</code> class implements a command-line tool allowing to change the indexing specification of a <code class="interfacename">Library</code> and then to re-index this <code class="interfacename">Library</code>.</p><pre class="programlisting">        Library lib = libManager.openLibrary(libName);

        try {
            verbose("Loading indexing specifications from '" + 
                    indexingFile + "'...");
            Indexing indexing = loadIndexing(indexingFile);<a class="co" name="reindex_loadIndexing" href="programming.html#reindex_loadIndexing_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
            lib.setIndexing(indexing);<a class="co" name="reindex_setIndexing" href="programming.html#reindex_setIndexing_2"><img src="images/callouts/2.png" alt="2" border="0"></a>

            verbose ("Re-indexing library '" + libName + "'...");
            lib.reIndex();<a class="co" name="reindex_reIndex" href="programming.html#reindex_reIndex_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
        } finally {
            shutdown(lib, libManager);
        }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="reindex_loadIndexing_2"></a><a href="#reindex_loadIndexing"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>The <code class="classname">Indexing</code> specification is simply loaded from an XML file by using the <a class="ulink" href="../javadoc/com/qizx/api/Indexing.html#parse(org.xml.sax.InputSource)" target="_top"><code class="methodname">Indexing.parse</code></a> method:</p><pre class="programlisting">    private static Indexing loadIndexing(File file) 
        throws IOException, SAXException, QizxException {
        Indexing indexing = new Indexing();

        String systemId = file.toURI().toASCIIString();
        <span class="bold"><strong>indexing.parse</strong></span>(new InputSource(systemId));

        return indexing;
    }</pre><p>Alternatively, it is possible to programmatically create an <code class="classname">Indexing</code> object by invoking methods such as <a class="ulink" href="../javadoc/com/qizx/api/Indexing.html#addAttributeRule(com.qizx.api.QName,%20com.qizx.api.QName[],%20int)" target="_top"><code class="methodname">Indexing.addAttributeRule</code></a>, <a class="ulink" href="../javadoc/com/qizx/api/Indexing.html#addElementRule(com.qizx.api.QName,%20com.qizx.api.QName[],%20int)" target="_top"><code class="methodname">Indexing.addElementRule</code></a>, etc.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="reindex_setIndexing_2"></a><a href="#reindex_setIndexing"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Library.html#setIndexing(com.qizx.api.Indexing)" target="_top"><code class="methodname">Library.setIndexing</code></a> changes the indexing specifications of a <code class="interfacename">Library</code>, but does not automatically re-index the <code class="interfacename">Library</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="reindex_reIndex_2"></a><a href="#reindex_reIndex"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p><a class="ulink" href="../javadoc/com/qizx/api/Library.html#reIndex()" target="_top"><code class="methodname">Library.reIndex</code></a> re-indexes a <code class="interfacename">Library</code>. This may take from a few seconds to several hours depending on the size of the <code class="interfacename">Library</code>.</p><p>Note that there is no need to invoke <code class="methodname">Library.commit</code> after <code class="methodname">reIndex</code>.</p></td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="reindex_custom_sieve"></a>7.2.&nbsp;Writing a custom Indexing.NumberSieve</h3></div></div></div><p>This time, query <a class="ulink" href="../samples/book_queries/21.xq" target="_top"><code class="filename">21.xq</code></a></p><pre class="programlisting"><span class="emphasis"><em>(: Find all books published before 1960 (e.g. The Caves of Steel). :)</em></span>
declare namespace t = "http://www.qizx.com/namespace/Tutorial";

collection("/")//t:book[<span class="bold"><strong>t:publicationDate</strong></span> &lt; 1960]/t:title</pre><p>gives no result because the <code class="sgmltag-element">t:publicationDate</code> element is not indexed as a number<sup>[<a href="programming.html#ftn.reindex_ant_run2" class="footnoteref">13</a>]</sup>. The reason of this problem is that the element contains a Roman numeral year date (example: "<code class="literal">MCMLIV</code>" = 1954).</p><p>The predefined string-to-number converter, <a class="ulink" href="../javadoc/com/qizx/api/util/text/FormatNumberSieve.html" target="_top"><code class="classname">com.qizx.api.util.text.FormatNumberSieve</code></a>, is very flexible but not to the point of converting Roman numeral year dates to numbers. Therefore the only way to solve the problem is:</p><div class="orderedlist"><ol type="1"><li><p>To write a custom string-to-number converter (called a <em class="firstterm">sieve</em> in Qizx parlance), that is, to implement interface <a class="ulink" href="../javadoc/com/qizx/api/Indexing.NumberSieve.html" target="_top"><code class="interfacename">Indexing.NumberSieve</code></a>.</p></li><li><p>To properly declare this custom sieve in <a class="ulink" href="../samples/programming/reindex/indexing.xml" target="_top"><code class="filename">indexing.xml</code></a>, our custom indexing specification.</p><pre class="programlisting">  &lt;element name="t:publicationDate" context="t:book" 
           as="numeric" sieve="<span class="bold"><strong>RomanNumberSieve</strong></span>" /&gt;</pre></li><li><p>To make sure that the code of our custom sieve is referenced in the <code class="envar">CLASSPATH</code>.</p></li></ol></div><p>Excerpts of <a class="ulink" href="../samples/programming/reindex/RomanNumberSieve.java" target="_top"><code class="filename">RomanNumberSieve.java</code></a>:</p><pre class="programlisting">public final class RomanNumberSieve implements Indexing.NumberSieve {
    ...
    public double convert(String text) {<a class="co" name="reindex_convert" href="programming.html#reindex_convert_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
        double converted = 0;

        char[] chars = text.trim().toUpperCase().toCharArray();
        int maxSymbolValue = -1;

        for (int j = chars.length-1; j &gt;= 0; --j) {
            char c = chars[j];

            Symbol symbol = null;
            for (int i = 0; i &lt; SYMBOLS.length; ++i) {
                if (SYMBOLS[i].symbol == c) {
                    symbol = SYMBOLS[i];
                    break;
                }
            }
            if (symbol == null) {
                return Double.NaN;
            }

            if (symbol.value &gt;= maxSymbolValue) {
                // Example: second "M" in "MCMXC" (1990).
                maxSymbolValue = symbol.value;
                converted += maxSymbolValue;
            } else {
                // Example: first "C" in "MCMXC" (1990).
                converted -= symbol.value;
            }
        }

        return converted;
    }

    public void setParameters(String[] parameters) {}<a class="co" name="reindex_setParameters" href="programming.html#reindex_setParameters_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
    public String[] getParameters() { return null; }
    ...
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="reindex_convert_2"></a><a href="#reindex_convert"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>A <code class="interfacename">Indexing.NumberSieve</code> basically converts a <code class="classname">String</code> to a <span class="type">double</span>. It should return <code class="literal">Double.NaN</code> when the conversion fails.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="reindex_setParameters_2"></a><a href="#reindex_setParameters"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>Like all <code class="interfacename">Indexing.Sieve</code>s, an <code class="interfacename">Indexing.NumberSieve</code> can be parametrized. This feature is not useful in the case of <code class="classname">RomanNumberSieve</code>.</p></td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8037"></a>7.3.&nbsp;Compiling and running the code of this lesson</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">ReIndex</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/reindex/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/reindex/</code> directory.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run</strong></span> in the <code class="filename">docs/samples/programming/reindex/</code> directory to re-index the "<code class="literal">Tutorial</code>" <code class="interfacename">Library</code> using <a class="ulink" href="../samples/programming/reindex/indexing.xml" target="_top"><code class="filename">indexing.xml</code></a>, our customized indexing specification.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run2</strong></span> in the <code class="filename">docs/samples/programming/query/</code> directory to check that the <a class="ulink" href="../samples/book_queries/20.xq" target="_top"><code class="filename">20.xq</code></a> and <a class="ulink" href="../samples/book_queries/21.xq" target="_top"><code class="filename">21.xq</code></a> queries now return the expected results.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="lesson_addmeta"></a>8.&nbsp;Adding metadata to Documents</h2></div></div></div><p>A <code class="interfacename">LibraryMember</code>, <code class="interfacename">Collection</code> or <code class="interfacename">Document</code>, has not only a content, but also <em class="firstterm">properties</em>. Properties are also explained in the chapter <a class="link" href="getting_started.html#plesson_addmeta" title="8.&nbsp;Using Metadata Properties">Getting Started</a>.</p><p>A property has a name (<code class="classname">String</code>) and a value (any <code class="classname">Object</code> implementing <code class="interfacename">java.io.Serializable</code>).</p><p>Qizx automatically adds a few system properties to all <code class="interfacename">LibraryMember</code>s. The most useful system properties are:</p><div class="variablelist"><dl><dt><span class="term">nature</span></dt><dd><p>The nature of the <code class="interfacename">LibraryMember</code>: "<code class="literal">collection</code>" or "<code class="literal">document</code>".</p></dd><dt><span class="term">path</span></dt><dd><p>The absolute path of the <code class="interfacename">LibraryMember</code>. Example: "<code class="literal">/Author Blurbs/Philip_Jose_Farmer.xhtml</code>".</p></dd></dl></div><p>But the real benefit of supporting properties is to allow an application to attach private information to a <code class="interfacename">LibraryMember</code>.</p><p>The <code class="classname">AddMeta</code> class implements a very specific command-line tool which allows to add <em class="firstterm">metadata</em><sup>[<a name="d0e8169" href="#ftn.d0e8169" class="footnote">14</a>]</sup> to <code class="interfacename">Document</code>s stored in the "<code class="literal">/Author Blurbs</code>" <code class="interfacename">Collection</code>. Remember that the <code class="interfacename">Document</code>s stored in that <code class="interfacename">Collection</code> are copies of articles found on <a class="ulink" href="http://en.wikipedia.org/wiki/Main_Page" target="_top">Wikipedia</a>. The <code class="classname">AddMeta</code> class allows to annotate a <code class="interfacename">Document</code> with the following metadata:</p><div class="variablelist"><dl><dt><span class="term">copyDate</span></dt><dd><p>The date of the Wikipedia article. A <code class="classname">java.util.Date</code> object.</p></dd><dt><span class="term">copiedURL</span></dt><dd><p>The location of the Wikipedia article. A <code class="classname">java.net.URL</code> object.</p></dd><dt><span class="term">license</span></dt><dd><p>The license<sup>[<a name="d0e8222" href="#ftn.d0e8222" class="footnote">15</a>]</sup> attached to the Wikipedia article. A <code class="classname">String</code>.</p></dd></dl></div><p>Excerpts of <a class="ulink" href="../samples/programming/addmeta/AddMeta.java" target="_top"><code class="filename">AddMeta.java</code></a>:</p><pre class="programlisting">        ...
        Collection collection = lib.getCollection(collectionPath);
        if (collection == null) {
            error("'" + collectionPath + "' is not a collection");
            return;
        }

        LibraryMemberIterator iter = collection.getChildren();
        while (iter.moveToNextMember()) {<a class="co" name="addmeta_iterate" href="programming.html#addmeta_iterate_2"><img src="images/callouts/1.png" alt="1" border="0"></a>
            LibraryMember m = iter.getCurrentMember();

            if (m.isDocument()) {
                String name = trimExtension(m.getName());

                Info info = (Info) nameToInfo.get(name);<a class="co" name="addmeta_find_info" href="programming.html#addmeta_find_info_2"><img src="images/callouts/2.png" alt="2" border="0"></a>
                if (info == null) {
                    warning("No meta-data about '" + m.getPath() + "'...");
                } else {
                    verbose("Adding meta-data to '" + m.getPath() + "'...");
                    m.setProperty("copyDate", info.copyDate);<a class="co" name="addmeta_setProperty" href="programming.html#addmeta_setProperty_2"><img src="images/callouts/3.png" alt="3" border="0"></a>
                    m.setProperty("copiedURL", info.copiedURL);
                    m.setProperty("license", license);
                }
            }
        }
        ...</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="addmeta_iterate_2"></a><a href="#addmeta_iterate"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left"><p>Iterate over the members of <code class="interfacename">Collection</code> "<code class="literal">/Author Blurbs</code>".</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="addmeta_find_info_2"></a><a href="#addmeta_find_info"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left"><p>If an entry having the same name as current <code class="interfacename">LibraryMember</code> <code class="literal"><code class="varname">m</code></code> is found in <code class="classname">HashMap</code> <code class="literal">nameToInfo</code>, add the "<code class="literal">copyDate</code>", "<code class="literal">copiedURL</code>" and "<code class="literal">license</code>" properties to <code class="interfacename">LibraryMember</code> <code class="varname">m</code>.</p><p><code class="classname">HashMap</code> <code class="literal">nameToInfo</code> maps <code class="literal">String</code>s (<code class="interfacename">LibraryMember</code> names) to <code class="classname">Info</code> objects.</p><pre class="programlisting">    private static final class Info {
        public final Date copyDate;
        public final URL copiedURL;

        public Info(Date copyDate, URL copiedURL) {
            this.copyDate = copyDate;
            this.copiedURL = copiedURL;
        }
    }</pre><p>The content of <code class="classname">HashMap</code> <code class="literal">nameToInfo</code> is parsed from <a class="ulink" href="../samples/book_data/Author%20Blurbs/Wikipedia/LocalCopyInfo.txt" target="_top"><code class="filename">LocalCopyInfo.txt</code></a>. The value of <code class="classname">String</code> <code class="varname">license</code> is loaded from <a class="ulink" href="../samples/book_data/Author%20Blurbs/Wikipedia/License.txt" target="_top"><code class="filename">License.txt</code></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="addmeta_setProperty_2"></a><a href="#addmeta_setProperty"><img src="images/callouts/3.png" alt="3" border="0"></a> </p></td><td valign="top" align="left"><p>Method <a class="ulink" href="../javadoc/com/qizx/api/LibraryMember.html#setProperty(java.lang.String,%20java.lang.Object)" target="_top"><code class="methodname">LibraryMember.setProperty</code></a> can be used to add a new property or to replace the value of an existing one.</p></td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8333"></a>8.1.&nbsp;Compiling and running the code of this lesson</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Compile class <code class="classname">AddMeta</code> by executing <span class="command"><strong>ant</strong></span> (see <a class="ulink" href="../samples/programming/addmeta/build.xml" target="_top"><code class="filename">build.xml</code></a>) in the <code class="filename">docs/samples/programming/addmeta/</code> directory.</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run</strong></span> in the <code class="filename">docs/samples/programming/addmeta/</code> directory to add the metadata found in <a class="ulink" href="../samples/book_data/Author%20Blurbs/Wikipedia/LocalCopyInfo.txt" target="_top"><code class="filename">LocalCopyInfo.txt</code></a> to the corresponding <code class="interfacename">Document</code>s of <code class="interfacename">Collection</code> "<code class="literal">/Author Blurbs</code>".</p></li><li><p>Run <span class="command"><strong>ant&nbsp;run3</strong></span> in the <code class="filename">docs/samples/programming/query/</code> directory to execute <a class="ulink" href="../samples/book_queries/30.xq" target="_top"><code class="filename">30.xq</code></a>, a query making use of some of the properties we have just added:</p><pre class="programlisting"><span class="emphasis"><em>(: List the original, Wikipedia, URLs of author blurbs containing 
   word "Russian" and copied locally after September 15, 2007. :)</em></span>
declare namespace html = "http://www.w3.org/1999/xhtml";

for $doc in xlib:query-properties("/Author Blurbs/*.xhtml",
                                  <span class="bold"><strong>copyDate</strong></span> ge xs:date("2007-09-15"))
where $doc/*[ft:contains("Russian")]
return xlib:get-property($doc, "<span class="bold"><strong>copiedURL</strong></span>")</pre><p><code class="function">xlib:query-properties</code> and <code class="function">xlib:get-property</code> are XQuery <span class="emphasis"><em>extension</em></span> functions, specific to Qizx, documented in <a class="xref" href="library_extensions.html" title="Chapter&nbsp;14.&nbsp;XML Library extension functions">Chapter&nbsp;14, <i>XML Library extension functions</i></a>.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e8410"></a>9.&nbsp;Convenience and utility classes provided by the API</h2></div></div></div><p>In addition to the main packages <span class="package">com.qizx.api</span> and <span class="package">com.qizx.api.fulltext</span>, the Java API of Qizx provides packages containing miscellaneous utilities: their root is <span class="package">com.qizx.api.util</span>, and there are specialized sub-packages.</p><p>This section is a short presentation of main functionalities of these packages. For more details, please consult the <a class="ulink" href="../javadoc/index.html" target="_top">Javadocumentation</a>.</p><p></p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8430"></a>9.1.&nbsp;Package com.qizx.api.util</h3></div></div></div><p>The main package contains implementations of API interfaces and some useful adapters.</p><h4><a name="d0e8435"></a>Default Implementations</h4><div class="itemizedlist"><ul type="disc"><li><p><span class="interface">DefaultModuleResolver</span> is the default implementation of <span class="interface">ModuleResolver</span>. By plugging a subclass of <code class="classname">DefaultModuleResolver</code> in a LibraryManager or a XQuerySessionManager, it is possible to change the way modules are accessed.</p></li></ul></div><h4><a name="d0e8449"></a>Implementations of XMLPushStream</h4><p><span class="interface">XMLPushStream</span> is a generic interface which is roughly equivalent to SAX2. Qizx uses it rather than using SAX2 because SAX2 is not well adapted to the XQuery Data Model. Adapters to and from SAX2 are provided.</p><p>XMLPushStream allows transferring XML content in a "push" style. It is typically used to export a Node item, but it can also be used to compute and store a Document into an XML Library.</p><div class="itemizedlist"><ul type="disc"><li><p>The most useful implementation is <span class="interface">XMLSerializer</span>. It allows transforming XML content to a character stream.</p></li><li><p>Adapter to SAX: <span class="interface">PushStreamToSAX</span> converts to a flow of SAX2 events.</p></li><li><p>Adapter to DOM: <span class="interface">PushStreamToDOM</span> builds a DOM document.</p></li><li><p>Builder of internal XML Data Model: <span class="interface">CorePushBuilder</span> allows creating a representation of the internal Data Model that can be accessed through the com.qizx.api.Node interface.</p></li></ul></div><p>There is also <span class="interface">SAXToPushStream</span>, a reverse adapter from SAX to <code class="classname">XMLPushStream</code> which is internally used for loading XML documents into a database using the standard JAXP interface.</p><h4><a name="d0e8490"></a>Adapters for JAXP transformations</h4><p><span class="interface">NodeSource</span> is a subclass of <span class="interface">javax.xml.transform.sax.SAXSource</span>. It can be used to pass a Qizx Node as a source to any XSLT engine supporting JAXP (namely Saxon and Xalan).</p><p>Conversely, <span class="interface">PushStreamResult</span> is a subclass of class <span class="interface">javax.xml.transform.sax.SAXResult</span>, wrapping any <code class="classname">XMLPushStream</code>. Its typical use is with Library.beginImportDocument: it allows directly reimporting the result of an XSLT transformation into a Document of a database (XML Library).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8510"></a>9.2.&nbsp;Package com.qizx.api.util.fulltext</h3></div></div></div><h4><a name="d0e8513"></a>Default Implementations</h4><p>Implementations of full-text interfaces:</p><div class="itemizedlist"><ul type="disc"><li><p>DefaultFullTextFactory</p></li><li><p>DefaultTextTokenizer</p></li><li><p>DefaultScorer</p></li></ul></div><h4><a name="d0e8527"></a>Utilities</h4><div class="itemizedlist"><ul type="disc"><li><p><span class="interface">FullTextHighlighter</span> is an iterator extending <span class="interface">XMLPullStream</span>, it distinguishes terms of a full-text query. It is basically used for implementing the ft:highlight extension function.</p></li><li><p><span class="interface">FullTextSnippetExtractor</span> extracts a snippet from a document or a XML Node, attempting to show most of the terms of a full-text query within N words (by default 20). It is also an iterator extending <span class="interface">XMLPullStream</span>. It is used for implementing the ft:snippet extension function.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8546"></a>9.3.&nbsp;Package com.qizx.api.util.accesscontrol</h3></div></div></div><p>Contains a simple Unix-like implementation of interface <span class="interface">AccessControl</span>.</p></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e5036" href="#d0e5036" class="para">3</a>] </sup>&#8220;<span class="quote">In theory, it is kind of like Make, without Make's wrinkles</span>&#8221; say its authors.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e5168" href="#d0e5168" class="para">4</a>] </sup>The name of the <code class="interfacename">Library</code> used in this tutorial is "<code class="literal">Tutorial</code>".</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e5918" href="#d0e5918" class="para">5</a>] </sup>Remember that a <code class="interfacename">Library</code> is at the same time a database and the <span class="emphasis"><em>transactional session</em></span> used to modify and/or query this database.</p></div><div class="footnote"><p><sup>[<a name="ftn.put_acid" href="#put_acid" class="para">6</a>] </sup>Qizx has the <acronym class="acronym">ACID</acronym> capabilities of a transactional database: Atomicity, Consistency, Isolation, Durability.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e6149" href="#d0e6149" class="para">7</a>] </sup>At worst, lock the root <code class="interfacename">Collection</code>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e6187" href="#d0e6187" class="para">8</a>] </sup>Libraries are relatively lightweight objects. Opening a <code class="interfacename">Library</code> is cheap in terms of memory and CPU usage.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e6464" href="#d0e6464" class="para">9</a>] </sup><a class="ulink" href="http://www.xml.com/pub/a/2003/09/17/stax.html" target="_top">"<em class="citetitle">An Introduction to StAX</em>"</a> by Elliotte Rusty Harold. Recommended StAX implementation: <a class="ulink" href="http://woodstox.codehaus.org/" target="_top">Woodstox</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.ktrout" href="#ktrout" class="para">10</a>] </sup>Kilgore Trout is not an actual author. This is the pseudonym used by <a class="ulink" href="http://www.pjfarmer.com/" target="_top">Philip Jos&eacute; Farmer</a> to write the "Venus on the Half-Shell" Science-Fiction novel.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e7313" href="#d0e7313" class="para">11</a>] </sup>Document Object Model. Actually the term used in the XML Query literature is <em class="glossterm">XQuery/XPath2 Data Model</em> or DM for short.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e7680" href="#d0e7680" class="para">12</a>] </sup>Not a <code class="interfacename">javax.xml.namespace.QName</code> as found in the <span class="trademark">Java</span>&#8482; runtime, starting from version 1.5.</p></div><div class="footnote"><p><sup>[<a name="ftn.reindex_ant_run2" href="#reindex_ant_run2" class="para">13</a>] </sup>Run <span class="command"><strong>ant&nbsp;run2</strong></span> in the <code class="filename">docs/samples/programming/query/</code> directory to check that.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e8169" href="#d0e8169" class="para">14</a>] </sup>Data about data.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e8222" href="#d0e8222" class="para">15</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Wikipedia:Text_of_the_GNU_Free_Documentation_License" target="_top">GNU Free Documentation License</a>.</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="dev_guide.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="dev_guide.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="efficient_queries.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part&nbsp;III.&nbsp;Developer's Guide&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;11.&nbsp;Writing efficient queries</td></tr></table></div></body></html>