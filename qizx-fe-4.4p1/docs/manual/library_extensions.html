<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;14.&nbsp;XML Library extension functions</title><link rel="stylesheet" href="html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.1"><link rel="start" href="index.html" title="Qizx Manual"><link rel="up" href="reference.html" title="Part&nbsp;IV.&nbsp;Reference"><link rel="prev" href="fulltext_extensions.html" title="Chapter&nbsp;13.&nbsp;Full-text XQuery extension functions"><link rel="next" href="admin_extensions.html" title="Chapter&nbsp;15.&nbsp;Administration extension functions"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;14.&nbsp;XML Library extension functions</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="fulltext_extensions.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;IV.&nbsp;Reference</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="admin_extensions.html">Next</a></td></tr></table><hr></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="library_extensions"></a>Chapter&nbsp;14.&nbsp;XML Library extension functions</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="library_extensions.html#predef_props">1. Predefined properties</a></span></dt></dl></div><p>These XQuery functions provide an access to the XML Library API.</p><p>They give XQuery applications the capacity to browse Libraries and Collections, get and modify the metadata, create and delete documents.</p><p>Administration functions such as creating and deleting Libraries are documented in the next chapter.</p><p>Please note the following points:</p><div class="itemizedlist"><ul type="disc"><li><p>objects returned and handled by such functions are in general foreign objects (type <code class="literal">xdt:object</code>) wrapping objects Document, Collection of the Java API of Qizx.</p></li><li><p>Yet they can be used as the origin of a path expression, in the same way as functions <code class="function">fn:doc</code> or <code class="function">fn:collection</code>. This is an extension of the semantics of Path expressions. For example theses two expressions are equivalent:</p><pre class="programlisting">fn:collection("/shakespeare/comedies")//LINE

xlib:collection("/shakespeare/comedies")//LINE</pre></li><li><p>Functions that modify a XML Library (store-document, set-property, delete) should always be wrapped inside a try/catch construct, as they may generate errors. The try/catch also ensures that operations in a sequence are all performed, and in the specified order. This is otherwise not guaranteed, as XQuery is a functional language whose implementation can typically use rewriting and lazy evaluation techniques. Example:</p><pre class="programlisting">try {
  xlib:delete-member("/foo/bar.xml"),
  xlib:commit()
} catch($err) {
  xlib:rollback(),
  element error { $err }
}</pre></li></ul></div><h2><a name="d0e11537"></a>Function reference</h2><div class="variablelist"><dl><dt><a name="fn.collection"></a><span class="term"><pre class="synopsis">fn:collection (<em class="replaceable"><code>$path</code></em> as xs:string)
   as node()*
fn:collection (<em class="replaceable"><code>$path-pattern</code></em> as xs:string, <em class="replaceable"><code>$predicate</code></em>)
   as node()*</pre></span></dt><dd><p>This is the standard <code class="function">collection()</code> function of XQuery, but with extensions.</p><p><b>Parameter <em class="replaceable"><code>$path</code></em>:&nbsp;</b>This argument can have several meanings:</p><div class="itemizedlist"><ul type="disc"><li><p>path of a collection inside the current XML Library: all documents within the collection (at any level) are part of the result.</p><p>If no such collection can be found, an error is raised.</p></li><li><p>It can also be a list of documents paths, separated by commas or semicolons.</p><div class="itemizedlist"><ul type="circle"><li><p>A normal path (without wildcard characters) is treated as per the function <code class="function">fn:doc()</code>. So it can either be part of a XML Library, or be an external document (file or URL) parsed on the fly.</p></li><li><p>If a path contains the wildcard characters <code class="function">*</code> or <code class="function">?</code>, it is treated as a file pattern and expanded. Attention: wildcard characters are currently accepted only in the file name, not in the path of the parent directory.</p><p>For example <code class="literal"><code class="code">collection("/home/data1/*.xml;/home/data2/*.xml")</code></code> can be expanded, while <code class="literal"><code class="code">collection("/home/*/*.xml;")</code></code> currently cannot be expanded.</p></li></ul></div><p>All of these documents must be reachable, or an error is raised.</p></li></ul></div><p><b>Parameter <em class="replaceable"><code>$path-pattern</code></em>:&nbsp;</b>The (extended) second form of the function accept a path pattern with wildcard characters "<code class="literal">*</code>" , "<code class="literal">**</code>"and "<code class="literal">?</code>".</p><div class="itemizedlist"><ul type="disc"><li><p>A document whose path matches the pattern is part of the result.</p></li><li><p>If the pattern matches the path of a Collection, then all documents within the collection (at any level) are added to the result.</p></li><li><p>If there are not wildcard characters, but the pattern is the path of a Collection, then all documents within the collection (at any level) are part of the result (like in the other form of the function).</p></li></ul></div><p>The wildcard characters have the following (usual) meaning:</p><div class="itemizedlist"><ul type="disc" compact><li><p>Question mark "<code class="literal">?</code>": matches a single character.</p></li><li><p>Star "<code class="literal">*</code>": matches any sequence of characters but the slash.</p><p>For example the pattern <code class="literal">/a/b/*.xml</code> matches the document path <code class="literal">/a/b/doc.xml</code>.</p></li><li><p>Double star "<code class="literal">**</code>": matches any sequence of characters including the slash.</p><p>For example the pattern <code class="literal">/**/doc.xml</code> matches the document path <code class="literal">/a/b/doc.xml</code>.</p></li></ul></div><p><b>Parameter <em class="replaceable"><code>$predicate</code></em>:&nbsp;</b>This is a logical expression on the properties of Collections and Documents in a XML Library.</p><p>Properties can be predefined (like <code class="code">path</code> and <code class="code">nature</code>) or can be added by function <code class="function">xlib:set-property</code> <a class="link" href="library_extensions.html#set-property">(see below)</a>.</p><p>Example: this expression returns the document nodes of all documents within the library whose property 'import-date' is more recent than the value below:</p><pre class="programlisting">collection("/", import-date &gt; xs:date('2006-12-31'))</pre><p><b>Returned value:&nbsp;</b>a sequence of <span class="emphasis"><em>document nodes</em></span>. An error can be raised in some cases (see above).</p></dd><dt><span class="term"><pre class="synopsis">xlib:collection (<em class="replaceable"><code>$path</code></em> as xs:string)
  as xdt:object[Collection]?</pre></span></dt><dd><p>Finds a Collection by path.</p><p><b>Parameter <em class="replaceable"><code>$path</code></em>:&nbsp;</b>path of the collection inside the current XML Library.</p><p><b>Returned value:&nbsp;</b>a Collection handle, or the empty sequence if the collection cannot be found.</p><p>Attention, this is not equivalent to <code class="function">fn:collection</code>: here a handle to a collection is returned. It is meant for handling metadata properties or locking. However this object can also be used as the origin of a path expression.</p></dd><dt><span class="term"><pre class="synopsis">xlib:parent-collection (<em class="replaceable"><code>$lib-member</code></em>)
  as xdt:object[Collection]?</pre></span></dt><dd><p>Returns the parent (enclosing) Collection of a Document or a Collection.</p><p><b>Parameter <em class="replaceable"><code>$lib-member</code></em>:&nbsp;</b>handle of a Collection or a Document, or its path as a string.</p><p><b>Returned value:&nbsp;</b>a Collection handle, or the empty sequence if the object is the root collection.</p></dd><dt><span class="term"><pre class="synopsis">xlib:parent-collection (<em class="replaceable"><code>$node</code></em> as node())
  as xdt:object[Collection]?</pre></span></dt><dd><p>Returns the parent (enclosing) Collection of a XML node.</p><p><b>Parameter <em class="replaceable"><code>$node</code></em>:&nbsp;</b>a node of a Document stored in a XML Library.</p><p><b>Returned value:&nbsp;</b>a Collection handle, or the empty sequence if the node does not belong to a document of a XML Library.</p></dd><dt><span class="term"><pre class="synopsis">xlib:document (<em class="replaceable"><code>$path</code></em> as xs:string)
  as xdt:object[Document]?</pre></span></dt><dd><p>Finds a document by its complete path in the XML Library. Returns a descriptor of the document, which can be used for handling metadata, locking.</p><p><b>Parameter <em class="replaceable"><code>$path</code></em>:&nbsp;</b>path of the document inside the current XML Library.</p><p><b>Returned value:&nbsp;</b>a Document handle, or the empty sequence if the document cannot be found.</p></dd><dt><span class="term"><pre class="synopsis">xlib:document(<em class="replaceable"><code>$collection</code></em> as xdt:object[Collection], $name as xs:string)
  as xdt:object[Document]?</pre></span></dt><dd><p>Finds a document by its name and its parent collection. Returns a descriptor of the document, which can be used for handling metadata, locking.</p><p><b>Parameter <em class="replaceable"><code>$name</code></em>:&nbsp;</b>simple name of the document.</p><p><b>Returned value:&nbsp;</b>a Document handle, or the empty sequence if the document cannot be found.</p></dd><dt><span class="term"><pre class="synopsis">xlib:document (<em class="replaceable"><code>$node</code></em> as node())
  as xdt:object[Document]?</pre></span></dt><dd><p>Finds the XML Document that contains a given node.</p><p><b>Parameter <em class="replaceable"><code>$node</code></em>:&nbsp;</b>a node of the XQuery Data Model.</p><p><b>Returned value:&nbsp;</b>a Document handle, or the empty sequence if the node does not belong to a XML Document (i.e. a constructed or parsed node).</p></dd><dt><span class="term"><pre class="synopsis">xlib:get-children (<em class="replaceable"><code>$collection</code></em> as xdt:object)
  as xdt:object[LibraryMember]*</pre></span></dt><dd><p>Returns Library Members (Documents and Collections) directly contained in a collection.</p><p><b>Parameter $collection:&nbsp;</b>handle of a collection.</p><p><b>Returned value:&nbsp;</b>a sequence of documents and collections. So it is possible to write:</p><pre class="programlisting">for $doc in xlib:get-children($collection) return ...</pre></dd><dt><span class="term"><pre class="synopsis">xlib:query-properties (<em class="replaceable"><code>$path-pattern</code></em> as xs:string, <em class="replaceable"><code>$predicate</code></em>)
  as xdt:object[LibraryMember]*</pre></span></dt><dd><p>This function searches for Documents and Collections whose properties satisfy a logical expression ($predicate). It is similar to the <a class="link" href="library_extensions.html#fn.collection">extended <code class="function">fn:collection</code> function</a>, but it returns a sequence of <span class="emphasis"><em>Documents and Collections</em></span>, while fn:collection returns the <span class="emphasis"><em>root nodes</em></span> of found documents.</p><p><b>Parameter <em class="replaceable"><code>$path-pattern</code></em>:&nbsp;</b>This is a path pattern with wildcard characters "<code class="literal">*</code>" , "<code class="literal">**</code>" and "<code class="literal">?</code>".</p><div class="itemizedlist"><ul type="disc"><li><p>A document or collection whose path matches the pattern is part of the result (provided that its properties satisfy the second argument <code class="code">predicate</code>).</p></li><li><p>If there are not wildcard characters, but the pattern is the path of a Collection, then all documents and sub-collections within the collection (at any level) are part of the result, provided that their properties satisfy the second argument <em class="replaceable"><code>$predicate</code></em>.</p></li></ul></div><p>The wildcard characters have the following (usual) meaning:</p><div class="itemizedlist"><ul type="disc" compact><li><p>Question mark "<code class="literal">?</code>": matches a single character.</p></li><li><p>Star "<code class="literal">*</code>": matches any sequence of characters but the slash.</p><p>For example the pattern <code class="literal">/a/b/*.xml</code> matches the document path <code class="literal">/a/b/doc.xml</code>.</p></li><li><p>Double star "<code class="literal">**</code>": matches any sequence of characters including the slash.</p><p>For example the pattern <code class="literal">/**/doc.xml</code> matches the document path <code class="literal">/a/b/doc.xml</code>.</p></li></ul></div><p><b>Parameter <em class="replaceable"><code>$predicate</code></em>:&nbsp;</b>This is a logical expression that must be satisfied by the properties of Collections and Documents which have been selected by the previous argument <em class="replaceable"><code>$path-pattern</code></em>.</p><p>Properties can be predefined (like <code class="code">path</code> and <code class="code">nature</code>) or can be added by function <code class="function">xlib:set-property</code> <a class="link" href="library_extensions.html#set-property">(see below)</a>.</p><p><b>Returned value:&nbsp;</b>a sequence of Library members (Documents and Collections).</p><p>Example: look for documents whose property <code class="literal">creation-date</code> is greater than a given value and have a <code class="literal">description</code> property which is a XML fragment containing the words "<code class="literal">suitable</code>" and "<code class="literal">purpose</code>".</p><pre class="programlisting">for $doc in
      xlib:queryProperties ("/2005/propositions/*",
                            creation-date &gt; xs:date("2003-03-03") and
                            x:fulltext(description, "suitable AND purpose"))
 return xlib:property($doc, "path")</pre></dd><dt><span class="term"><pre class="synopsis">function xlib:property-names (<em class="replaceable"><code>$lib-member</code></em>)
  as xs:string*</pre></span></dt><dd><p>Lists the metadata properties associated with an object in the library.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Predefined properties, created by default, are described in <a class="link" href="library_extensions.html#predef_props" title="1.&nbsp;Predefined properties">reference documentation</a>.</p></div><p><b>Parameter <em class="replaceable"><code>$lib-member</code></em>:&nbsp;</b>handle of a Collection or a Document, or its path as a string.</p><p><b>Returned value:&nbsp;</b>a sequence of the property names. The value of each property can be retrieved with the following function.</p></dd><dt><span class="term"><pre class="synopsis">function xlib:get-property (<em class="replaceable"><code>$lib-member</code></em>, <em class="replaceable"><code>$property-name</code></em> as xs:string)
  as item()?</pre></span></dt><dd><p>Retrieves the value of a metadata property associated with an object in the library.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Predefined properties, created by default, are described in <a class="link" href="library_extensions.html#predef_props" title="1.&nbsp;Predefined properties">reference documentation</a>.</p></div><p><b>Parameter <em class="replaceable"><code>$lib-member</code></em>:&nbsp;</b>handle of a Collection or a Document, or its path as a string.</p><p><b>Parameter <em class="replaceable"><code>$property-name</code></em>:&nbsp;</b>name of the property.</p><p><b>Returned value:&nbsp;</b>the current value of the property, any serializable object.</p></dd><dt><a name="set-property"></a><span class="term"><pre class="synopsis">function xlib:set-property (<em class="replaceable"><code>$lib-member</code></em>,
                            <em class="replaceable"><code>$property-name</code></em> as xs:string, $value as item())</pre></span></dt><dd><p>Sets the value of a metadata property of an object in the library. The property is created if necessary.</p><p>This function may be called only if the object is locked by a transaction, directly or indirectly (a document is locked if the enclosing collection is locked, or an enclosing closure collection is locked, or the whole library is locked).</p><p><b>Parameter <em class="replaceable"><code>$lib-member</code></em>:&nbsp;</b>handle of a Collection or a Document, or its path as a string.</p><p><b>Parameter <em class="replaceable"><code>$property-name</code></em>:&nbsp;</b>name of the property. The "<code class="literal">path</code>" and "<code class="literal">nature</code>" property names are reserved and cannot be modified.</p><p><b>Parameter <em class="replaceable"><code>$value</code></em>:&nbsp;</b>the new value of the property, any serializable object, in particular it can be a Node. Notice that it is not recommended to store massive amounts of data in properties.</p><p><b>Returned value:&nbsp;</b>none.</p></dd><dt><span class="term"><pre class="synopsis">function xlib:lock (<em class="replaceable"><code>$lib-member</code></em>*, <em class="replaceable"><code>$timeout</code></em> as xs:integer?)
   as xs:boolean</pre></span></dt><dd><p>Locks an object (Collection or Document) for modification. The object will be unlocked only by a commit or a rollback.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Attention</h3><p>It is not possible to make several calls to the lock function without invoking commit or rollback before each new lock (in other terms, only one lock is allowed per commit).</p></div><p><b>Parameter <em class="replaceable"><code>$lib-member</code></em>:&nbsp;</b>a sequence of Collection or a Document handles or paths.</p><p><b>Parameter <em class="replaceable"><code>$timeout</code></em>:&nbsp;</b>(optional) an integer number of milliseconds to wait if the object is already locked by another transaction. If the object is not unlocked within this duration, the function returns false.</p><p><b>Returned value:&nbsp;</b>If the objects could be locked, returns true. If false is returned, it can mean that one of the objects is locked by another session, or that one object was deleted by another session, or that the library member sequence was empty.</p></dd><dt><span class="term"><pre class="synopsis">function xlib:commit()</pre></span></dt><dd><p>Commits the current transaction and guarantees the modifications to be permanent.</p><p>All locked objects are unlocked. The changes become visible to other users (if they use refresh) and to new connections.</p><p><b>Returned value:&nbsp;</b>none (empty sequence).</p></dd><dt><span class="term"><pre class="synopsis">function xlib:rollback()</pre></span></dt><dd><p>Cancels the changes made in the current transaction and unlocks all locked objects.</p><p><b>Returned value:&nbsp;</b>none (empty sequence).</p></dd></dl></div><div class="variablelist"><dl><dt><span class="term"><pre class="synopsis">function xlib:write-document (<em class="replaceable"><code>$path</code></em> as xs:string, <em class="replaceable"><code>$contents</code></em> as node())
   as xdt:object[Document]
function xlib:write-document (<em class="replaceable"><code>$collection</code></em> as xdt:object[Collection], 
                              <em class="replaceable"><code>$name</code></em> as xs:string, <em class="replaceable"><code>$contents</code></em> as node())
   as xdt:object[Document]</pre></span></dt><dd><p>Creates or overwrites a document: this function can be used to edit document contents in XQuery, for example by transforming the contents of an existing document (using XQuery or XSLT) and storing back the result on the same document.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>In Qizx a document can only be replaced as a whole: it is not possible for example to only modify a sub-element, an attribute, or to append inside an existing document. Therefore it is not efficient to repeatedly modify a massive document; this can however be quite acceptable if the document is relatively small (say up to 100 Kb in size).</p><p>Future versions of Qizx will most likely support XQuery Update (an extension of XQuery that allows specifying transformations). However the same principle will apply, a XQuery Update produces a new document that replaces the former one as a whole.</p></div><p><b>Parameter <em class="replaceable"><code>$path</code></em>:&nbsp;</b>full path of the document inside the XML Library.</p><p><b>Parameter <em class="replaceable"><code>$collection</code></em>:&nbsp;</b>the enclosing collection. This object must be locked.</p><p><b>Parameter <em class="replaceable"><code>$name</code></em>:&nbsp;</b>name of the document, or a path relative to the collection (the enclosing collections are created automatically if necessary).</p><p><b>Parameter <em class="replaceable"><code>$contents</code></em>:&nbsp;</b>an node (element or document-node) and its subtree which become the contents of the stored document.</p><p><b>Returned value:&nbsp;</b>a handle on the new document. It can be used to set metadata properties on the document.</p></dd><dt><span class="term"><pre class="synopsis">function xlib:delete-member (<em class="replaceable"><code>$lib-member</code></em>)</pre></span></dt><dd><p>Deletes a document or a collection.</p><p><b>Parameter <em class="replaceable"><code>$lib-member</code></em>:&nbsp;</b>handle of a Collection or a Document, or its path as a string.</p><p><b>Returned value:&nbsp;</b>none.</p></dd><dt><span class="term"><pre class="synopsis">function xlib:rename-member(<em class="replaceable"><code>$src-path</code></em> as xs:string, <em class="replaceable"><code>$dst-path</code></em> as xs:string)</pre></span></dt><dd><p>Renames a document or a collection.</p><p><b>Parameter <em class="replaceable"><code>$src-path</code></em>:&nbsp;</b>original path of the Library member.</p><p><b>Parameter <em class="replaceable"><code>$dst-path</code></em>:&nbsp;</b>destination path of the Library member. Must not correspond with an existing library member. Must point inside an existing Collection.</p><p><b>Returned value:&nbsp;</b>none.</p></dd><dt><span class="term"><pre class="synopsis">function xlib:copy-member(<em class="replaceable"><code>$src-path</code></em> as xs:string, <em class="replaceable"><code>$dst-path</code></em> as xs:string)</pre></span></dt><dd><p>Copies a document or a collection.</p><p><b>Parameter <em class="replaceable"><code>$src-path</code></em>:&nbsp;</b>path of the source Library member. If it is a Collection, all the documents and sub-collections contained within are recursively copied.</p><p><b>Parameter <em class="replaceable"><code>$dst-path</code></em>:&nbsp;</b>destination path of the Library member. Must not correspond with an existing library member. Must point inside an existing Collection.</p><p><b>Returned value:&nbsp;</b>none.</p></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="predef_props"></a>1.&nbsp;Predefined properties</h2></div></div></div><p>The properties described here are created automatically when a document is stored into an XML Library.</p><p>NB: this can be controlled through the configuration property <code class="literal">doc_node_stats</code>.</p><p>The <a class="ulink" href="../javadoc/com/qizx/api/LibraryMemberObserver.html" target="_top"><code class="interfacename">LibraryMemberObserver</code></a> <code class="interfacename"> Collection</code> interface is the API allows implementing a handler which modifies this list (by adding other properties or deleting the predefined properties).</p><div class="variablelist"><dl><dt><span class="term">path</span></dt><dd><p>path of the Library member. Cannot be modified.</p><p>Value type: String.</p></dd><dt><span class="term">nature</span></dt><dd><p>Nature of the Library member.</p><p>Value type: String. Possible values are "document" and "collection".</p></dd><dt><span class="term">import-date</span></dt><dd><p>Date at which the document was imported (created or modified).</p><p>Value type: Date (xs:dateTime).</p></dd><dt><span class="term">user</span></dt><dd><p>If an access-control mechanism is defined, the name of the User who created or modified the document. The User descriptor is associated with the Library session.</p></dd><dt><span class="term">size</span></dt><dd><p>Size in bytes of the document. This value represents an internal storage size. It is in general 10% to 30% smaller than the size of a serialized representation of the document in XML.</p><p>Value type: integer (xs:integer).</p></dd><dt><span class="term">element-count, </span><span class="term">attribute-count, </span><span class="term">text-count, </span><span class="term">comment-count, </span><span class="term">pi-count</span></dt><dd><p>statistics: number of nodes of each kind in the document.</p><p>Value type: integer (xs:integer).</p></dd><dt><span class="term">dtd-name, </span><span class="term">dtd-public-id, </span><span class="term">dtd-system-id, </span><span class="term">dtd-internal-subset</span></dt><dd><p>When a DTD is specified in the document (DOCTYPE declaration), these properties collect respectively the name of the DTD, its system- or public id, and if provided by the XML parser the contents of the internal subset, if any.</p><p>Otherwise these properties are absent.</p></dd></dl></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="fulltext_extensions.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="reference.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="admin_extensions.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;13.&nbsp;Full-text XQuery extension functions&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;15.&nbsp;Administration extension functions</td></tr></table></div></body></html>